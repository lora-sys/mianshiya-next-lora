## ç¬¬ä¸€æ­¥ 

1. ç¬¬ä¸€æ­¥é¦–å…ˆctrl+shift+ræ‰“å¼€æœç´¢ï¼Œæ›¿æ¢æ¨¡å—åç§°
2. æ›¿æ¢åŒ…å
3. é…ç½®æ•°æ®åº“åç§°ä»¥åŠé…ç½®(application.yml)
4. git ä¼ è¾“ä»¥æ–¹ä¾¿éšæœºå›æ»šå†å²æ–‡ä»¶è®°å½•
5. debugæ¨¡å¼å¯åŠ¨
## ç¬¬äºŒæ­¥

> [!NOTE]
> mybatisxè¿›è¡Œæ•°æ®åº“çš„ä»£ç ç”Ÿæˆ

![[Pasted image 20251018131402.png]]
![[Pasted image 20251018131349.png]]
å¦‚æœå‡ºç°æ‰¾ä¸åˆ°ä¾èµ–æƒ…å†µï¼Œå¯åœ¨pom.xmlæ–‡ä»¶ä¸­åŠ å…¥mybatisx-generator-coreä¾èµ–
``` xml
        <dependency>  
<groupId>org.mybatis.generator</groupId>  
<artifactId>mybatis-generator-core</artifactId>  
            <version>1.4.2</version>  
  
        </dependency>
```
å¦‚æœmybatisxï¼Œä¸‹è½½å¤±è´¥å¯ä»githubä¸‹è½½zipåŒ…ï¼Œå¯¼å…¥æ’ä»¶
[[https://github.com/vvccsammy/mybatisx-idea-25.2/releases/tag/25.2]]
ç”Ÿæˆçš„ä»£ç åœ¨
![[Pasted image 20251018133313.png]]
```java
## @TableLogic

java

@TableLogic
private Integer isDelete;

- **é€»è¾‘åˆ é™¤æ³¨è§£**ï¼šæ ‡è®°è¯¥å­—æ®µä¸ºé€»è¾‘åˆ é™¤æ ‡å¿—å­—æ®µ
    
- **ä½œç”¨**ï¼šæ‰§è¡Œåˆ é™¤æ“ä½œæ—¶è‡ªåŠ¨å˜ä¸ºæ›´æ–°æ“ä½œï¼Œå°† isDelete å­—æ®µè®¾ç½®ä¸ºå·²åˆ é™¤çŠ¶æ€å€¼
    
- **é»˜è®¤è¡Œä¸º**ï¼š
    
    - åˆ é™¤æ—¶ï¼šUPDATE table SET is_delete = 1 WHERE id = ?
        
    - æŸ¥è¯¢æ—¶ï¼šè‡ªåŠ¨æ·»åŠ  WHERE is_delete = 0 æ¡ä»¶
```

```java
## @TableField(exist = false)

java

@TableField(exist = false)
private static final long serialVersionUID = 1L;

- **å­—æ®µæ’é™¤æ³¨è§£**ï¼šæ ‡è®°è¯¥å­—æ®µä¸æ˜¯æ•°æ®åº“è¡¨ä¸­çš„åˆ—
    
- **ä½œç”¨**ï¼šMyBatis-Plus æ“ä½œæ•°æ®åº“æ—¶ä¼šå¿½ç•¥æ­¤å­—æ®µ
    
- **serialVersionUID**ï¼šSerializable æ¥å£çš„åºåˆ—åŒ–ç‰ˆæœ¬æ ‡è¯†
```

è¿™ä¸ªæ³¨è§£ç»„åˆçš„ä½œç”¨æ˜¯ï¼š**å£°æ˜åºåˆ—åŒ–ç‰ˆæœ¬IDçš„åŒæ—¶ï¼Œé¿å…MyBatis-Pluså°†å…¶å½“ä½œæ•°æ®åº“å­—æ®µå¤„ç†**ã€‚
- âœ… åºåˆ—åŒ–åŠŸèƒ½æ­£å¸¸å·¥ä½œçš„ç‰ˆæœ¬æ§åˆ¶
    
- âœ… MyBatis-Plus ä¸ä¼šè¯¯å°†å…¶å½“ä½œæ•°æ®åº“å­—æ®µ
    
- âœ… ä»£ç æ„å›¾æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤


> [!NOTE] @TableLogic
> ## è¯¥æ³¨è§£ç”¨äºæ ‡è®°å®ä½“ç±»ä¸­çš„å­—æ®µä½œä¸ºé€»è¾‘åˆ é™¤å­—æ®µã€‚é€»è¾‘åˆ é™¤æ˜¯ä¸€ç§æ•°æ®ç®¡ç†ç­–ç•¥ï¼Œå®ƒä¸æ˜¯çœŸæ­£åœ°ä»æ•°æ®åº“ä¸­åˆ é™¤è®°å½•ï¼Œè€Œæ˜¯åœ¨è®°å½•ä¸­æ ‡è®°è¯¥è®°å½•ä¸ºå·²åˆ é™¤çŠ¶æ€ã€‚é€šè¿‡ä½¿ç”¨`@TableLogic`æ³¨è§£ï¼ŒMyBatis-Plus å¯ä»¥åœ¨æŸ¥è¯¢ã€æ›´æ–°å’Œåˆ é™¤æ“ä½œä¸­è‡ªåŠ¨å¤„ç†é€»è¾‘åˆ é™¤å­—æ®µçš„å€¼ã€‚

```
@TableName("sys_user")public class User {    @TableId    private Long id;    @TableField("nickname") // æ˜ å°„åˆ°æ•°æ®åº“å­—æ®µ "nickname"    private String name;    private Integer age;    private String email;    @TableLogic(value = "0", delval = "1") // é€»è¾‘åˆ é™¤å­—æ®µ    private Integer deleted;}
```

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œdeletedå­—æ®µè¢«æ ‡è®°ä¸ºé€»è¾‘åˆ é™¤å­—æ®µã€‚@TableLogicæ³¨è§£çš„valueå±æ€§æŒ‡å®šäº†é€»è¾‘æœªåˆ é™¤çš„å€¼ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯0ï¼‰ï¼Œè€Œdelvalå±æ€§æŒ‡å®šäº†é€»è¾‘åˆ é™¤çš„å€¼ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯1ï¼‰ã€‚

å½“æ‰§è¡ŒæŸ¥è¯¢æ“ä½œæ—¶ï¼ŒMyBatis-Plus ä¼šè‡ªåŠ¨è¿‡æ»¤æ‰æ ‡è®°ä¸ºé€»è¾‘åˆ é™¤çš„è®°å½•ï¼Œåªè¿”å›æœªåˆ é™¤çš„è®°å½•ã€‚åœ¨æ‰§è¡Œæ›´æ–°æ“ä½œæ—¶ï¼Œå¦‚æœæ›´æ–°æ“ä½œä¼šå¯¼è‡´é€»è¾‘åˆ é™¤å­—æ®µçš„å€¼å˜ä¸ºé€»è¾‘åˆ é™¤å€¼ï¼ŒMyBatis-Plus ä¼šè‡ªåŠ¨å°†è¯¥è®°å½•æ ‡è®°ä¸ºå·²åˆ é™¤ã€‚åœ¨æ‰§è¡Œåˆ é™¤æ“ä½œæ—¶ï¼ŒMyBatis-Plus ä¼šè‡ªåŠ¨å°†é€»è¾‘åˆ é™¤å­—æ®µçš„å€¼æ›´æ–°ä¸ºé€»è¾‘åˆ é™¤å€¼ï¼Œè€Œä¸æ˜¯ç‰©ç†åˆ é™¤è®°å½•ã€‚

ä½¿ç”¨@TableLogicæ³¨è§£å¯ä»¥å®ç°æ•°æ®çš„é€»è¾‘åˆ é™¤ï¼Œæœ‰åŠ©äºç»´æŠ¤æ•°æ®çš„å®Œæ•´æ€§å’Œå¯è¿½æº¯æ€§ï¼ŒåŒæ—¶é¿å…äº†ç‰©ç†åˆ é™¤æ“ä½œå¯èƒ½å¸¦æ¥çš„æ•°æ®ä¸¢å¤±é£é™©ã€‚å¼€å‘è€…æ— éœ€æ‰‹åŠ¨ç¼–å†™é€»è¾‘åˆ é™¤çš„ä»£ç ï¼ŒMyBatis-Plus ä¼šè‡ªåŠ¨å¤„ç†è¿™ä¸€è¿‡ç¨‹ã€‚

>


> [!NOTE] @TableId(type = IdType.ASSIGN_ID) mybatisxæ³¨è§£
> é›ªèŠ±ç®—æ³•ç”Ÿæˆé€’å¢idï¼Œæœ‰åŠ©äºåçˆ¬è™«
> **IdType æšä¸¾ç±»å‹å®šä¹‰**
> 

- `IdType.AUTO`ï¼šä½¿ç”¨æ•°æ®åº“è‡ªå¢ ID ä½œä¸ºä¸»é”®ã€‚
- `IdType.NONE`ï¼šæ— ç‰¹å®šç”Ÿæˆç­–ç•¥ï¼Œå¦‚æœå…¨å±€é…ç½®ä¸­æœ‰ IdType ç›¸å…³çš„é…ç½®ï¼Œåˆ™ä¼šè·Ÿéšå…¨å±€é…ç½®ã€‚
- `IdType.INPUT`ï¼šåœ¨æ’å…¥æ•°æ®å‰ï¼Œç”±ç”¨æˆ·è‡ªè¡Œè®¾ç½®ä¸»é”®å€¼ã€‚
- `IdType.ASSIGN_ID`ï¼šè‡ªåŠ¨åˆ†é…Â `ID`ï¼Œé€‚ç”¨äºÂ `Long`ã€`Integer`ã€`String`Â ç±»å‹çš„ä¸»é”®ã€‚é»˜è®¤ä½¿ç”¨é›ªèŠ±ç®—æ³•é€šè¿‡Â `IdentifierGenerator`Â çš„Â `nextId`Â å®ç°ã€‚@since 3.3.0
- `IdType.ASSIGN_UUID`ï¼šè‡ªåŠ¨åˆ†é…Â `UUID`ï¼Œé€‚ç”¨äºÂ `String`Â ç±»å‹çš„ä¸»é”®ã€‚é»˜è®¤å®ç°ä¸ºÂ `IdentifierGenerator`Â çš„Â `nextUUID`Â æ–¹æ³•
> [[https://baomidou.com/reference/annotation/]]
> åºåˆ—åŒ–-> id.->ç½‘ç»œä¼ è¾“ï¼Œåºåˆ—åŒ–.æ¶ˆæ¯é˜Ÿåˆ—ï¼Œredisåˆ†å¸ƒå¼å­˜å‚¨->ååºåˆ—åŒ–
private static final long ==serialVersionUID== = 1L;
## ç¬¬äºŒæ­¥
ä½¿ç”¨srcç›®å½•ä¸‹çš„generatorç›®å½•é‡Œçš„ä»£ç ç”Ÿæˆå™¨è„šæœ¬ï¼Œè¿è¡Œåç”Ÿæˆå¯¹åº”æ•°æ®åº“è¡¨çš„
1. controller
2. model/ dto vo
3. service

### lombackæ³¨è§£è§£å†³è®¾ç½® getid,tostringç­‰å‡½æ•°
##### @data,@EqualsAndHashCode(callSuper = true)`Â æ˜¯ Lombok æ³¨è§£ï¼Œç”¨äºåœ¨ç”ŸæˆÂ `equals()`Â å’ŒÂ `hashCode()`Â æ–¹æ³•æ—¶åŒ…å«çˆ¶ç±»çš„å­—æ®µ
```java
@EqualsAndHashCode(callSuper = true)  
@Data  
public class QuestionQueryRequest extends PageRequest implements Serializable {  
  
    /**  
     * id     */    private Long id;  
  
    /**  
     * id     */    private Long notId;  
  
    /**  
     * æœç´¢è¯  
     */  
    private String searchText;  
  
    /**  
     * æ ‡é¢˜  
     */  
    private String title;  
  
    /**  
     * å†…å®¹  
     */  
    private String content;  
  
    /**  
     * æ ‡ç­¾åˆ—è¡¨  
     */  
    private List<String> tags;  
  
    /**  
     * åˆ›å»ºç”¨æˆ· id  
     */    private Long userId;  
  
    private static final long serialVersionUID = 1L;  
}
```


### ç¬¬ä¸‰æ­¥
dotåŒ…çš„è¯·æ±‚ä»¥åŠvoå‰ç«¯å“åº”çš„ç±»


## ç¡®è®¤æ¥å£å’Œè¡¥å……æ¥å£
åç«¯æ ¸å¿ƒä¸šåŠ¡å¼€å‘
1. ç”¨æˆ·æ¨¡å—
    ç”¨æˆ·æ³¨å†Œï¼šä»¥åŠå®Œæˆ:æ¨¡æ¿è‡ªå¸¦
    ç”¨æˆ·ç™»å½•ï¼šå·²å®Œæˆï¼šæ¨¡æ¿è‡ªå¸¦
     ç®¡ç†å‘˜ï¼šå¢åˆ æ”¹æŸ¥ï¼šæ¨¡æ¿è‡ªå¸¦
 2. é¢˜åº“æ¨¡å—
     æŸ¥çœ‹é¢˜åº“åˆ—è¡¨ï¼š åˆ†é¡µè·å–é¢˜åº“æ¥å£  ï¼Œç”Ÿæˆå™¨ç”Ÿæˆï¼Œéœ€è¦ç¡®è®¤
     æŸ¥çœ‹é¢˜ç›®è¯¦æƒ…ï¼šå±•ç¤ºé¢˜åº“ä¸‹çš„é¢˜ç›®ï¼Œ æ ¹æ®idè·å–é¢˜åº“è¯¦æƒ…æ¥å£ï¼Œéœ€è¦å¼€å‘
     ç®¡ç†å‘˜ ç®¡ç†é¢˜åº“ -å¢åˆ æ”¹æŸ¥  ï¼š ç”Ÿæˆå™¨ç”Ÿæˆï¼Œéœ€è¦ç¡®è®¤
3.é¢˜ç›®æ¨¡å—
  é¢˜ç›®æœç´¢ï¼šåˆ†é¡µè·å–é¢˜ç›®æ¥å£ã€‚ ç”Ÿæˆå™¨ç”Ÿæˆï¼Œéœ€è¦ç¡®è®¤
  æŸ¥çœ‹é¢˜ç›®è¯¦æƒ…ï¼šè¿›å…¥åˆ·é¢˜é¡µé¢ã€‚ æ ¹æ®idè·å–é¢˜ç›®è¯¦æƒ…æ¥å£ï¼Œéœ€è¦ç¡®è®¤
  ç®¡ç†å‘˜  ç®¡ç†é¢˜ç›®-å¢åˆ æ”¹æŸ¥ï¼Œ  ç”Ÿæˆå™¨ç”Ÿæˆã€‚éœ€è¦ç¡®è®¤
  ç®¡ç†å‘˜  æ ¹æ®é¢˜åº“æŸ¥è¯¢é¢˜ç›® ï¼š æ ¹æ®é¢˜åº“idè·å–é¢˜ç›®åˆ—è¡¨ã€‚éœ€è¦å¼€å‘
  ç®¡ç†å‘˜  ä¿®æ”¹é¢˜ç›®æ‰€å±çš„é¢˜åº“ï¼š ä¿®æ”¹é¢˜ç›®æ‰€å±é¢˜åº“æ¥å£ï¼Œéœ€è¦å¼€å‘


## æ ¹æ®é¢˜åº“æŸ¥è¯¢é¢˜ç›®åˆ—è¡¨æ¥å£
æ ¹æ®é¢˜åº“çš„idæŸ¥è¯¢é¢˜ç›®åˆ—è¡¨
æŸ¥è¯¢æ—¶è¦å…ˆç”¨å…³è”è¡¨è·å–é¢˜ç›®idã€‚æ ¹æ®idä»é¢˜ç›®è¡¨æŸ¥è¯¢åˆ°é¢˜ç›®å®Œæ•´ä¿¡æ¯
joinè”è¡¨æŸ¥è¯¢å’Œä¸šåŠ¡å±‚å…³è”
```
SELECT
   q.id,
   q.title,
   q.tags,
   q.answer,
   q.userId,
   q.createdTime,
   q.updateTime,
FROM
   question_bank_question qbq
JOIN
   question q
ON 
   qbq.questionId=q.id
WHERE
   qbq.questionId = ?;  and??//æ›¿æ¢å…·ä½“çš„é¢˜åº“id

```
ä½¿ç”¨ä¸šåŠ¡å±‚åˆ†å¸ƒæŸ¥è¯¢
å…ˆæŸ¥è¯¢å…³è”è¡¨å¾—åˆ°é¢˜ç›®idï¼ŒæŠŠé¢˜ç›®idæ”¾åœ¨é›†åˆä¸­ï¼Œæ ¹æ®idä½¿ç”¨inæŸ¥è¯¢ä»é¢˜ç›®è¡¨æŸ¥è¯¢åˆ°é¢˜ç›®å®Œæ•´ä¿¡æ¯

```cpp

@EqualsAndHashCode(callSuper = true)  
@Data  
public class QuestionBankQueryRequest extends PageRequest implements Serializable {  
  
    /**  
     * id     */    private Long id;  
  
    /**  
     * id     */    private Long notId;  
  
    /**  
     * æœç´¢è¯  
     */  
    private String searchText;  
  
    /**  
     * æ ‡é¢˜  
     */  
    private String title;  
  
    /**  
     * å†…å®¹  
     */  
    private String content;  
  
    /**  
     * æè¿°  
     */  
    private String description;  
    /**  
     * æ ‡ç­¾åˆ—è¡¨  
     */  
    private List<String> tags;  
  
    /**  
     * å›¾ç‰‡  
     */  
    private String picture;  
  
    /**  
     * åˆ›å»ºç”¨æˆ· id  
     */    private Long userId;  
  
    /**  
     * é¢˜åº“ id  
     */    private Long questionBankId;  
  
    private static final long serialVersionUID = 1L;  
}
```

è¯·æ±‚å‚æ•°ä¸ºquestionBankId,ç›´æ¥è¡¥å……é¢˜ç›®æŸ¥è¯¢è¯·æ±‚é‡Œé¢

å¦‚æœè¦è€ƒè™‘å¯¹é¢˜ç›®é¢˜åº“å…³è”è¡¨åŒæ—¶æŸ¥è¯¢å’Œåˆ†é¡µï¼Œä½¿ç”¨sql joinå®ç°ï¼Œå› ä¸ºä¸šåŠ¡å±‚å¤„ç†å¤šè¡¨åˆ†é¡µæ¯”è¾ƒéº»çƒ¦,æ•°æ®é‡ä¸å¤§ç›´æ¥å…¨éƒ¨æŸ¥è¯¢
æ³¨æ„äº‹é¡¹ï¼š
ä¸è¦select*
æ³¨æ„åˆ¤æ–­åˆ—è¡¨çš„æ§åˆ¶
å–å‡ºidæ”¾åˆ°é›†åˆä¸­
ç›´æ¥å¤ç”¨ç›´æ¥æŸ¥è¯¢é¢˜ç›®çš„é€»è¾‘

## è·å–é¢˜ç›®è¯¦æƒ…æ¥å£
éœ€æ±‚ï¼šæ ¹æ®é¢˜ç›®idè·å–é¢˜åº“è¯¦æƒ…ï¼ŒåŒæ—¶éœ€è¦æŸ¥è¯¢é¢˜åº“å†…çš„é¢˜ç›®åˆ—è¡¨
åˆ†æï¼šè€ƒè™‘åˆ°é€‚é…ä¸åŒç§æƒ…å†µï¼Œç”¨ä¸€ä¸ªå­—æ®µæ¥è¡¨ç¤ºéœ€è¦å…³è”æŸ¥è¯¢é¢˜ç›®åˆ—è¡¨

å¼€å‘
è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œå•è¡¨æŸ¥è¯¢ï¼Œç„¶åå¤ç”¨å·²ç»å¼€å‘å¥½çš„æ ¹æ®é¢˜åº“idè·å–é¢˜ç›®åˆ—è¡¨çš„æ¥å£å³å¯
```java

@GetMapping("/get/vo")  
public BaseResponse<QuestionBankVO> getQuestionBankVOById(QuestionBankQueryRequest questionbankqueryrequest  ,HttpServletRequest request) {  
  
    ThrowUtils.throwIf(questionbankqueryrequest == null,ErrorCode.PARAMS_ERROR);  
    Long id = questionbankqueryrequest.getId();  
    ThrowUtils.throwIf(id <= 0, ErrorCode.PARAMS_ERROR);  
    // æŸ¥è¯¢æ•°æ®åº“  
    QuestionBank questionBank = questionBankService.getById(id);  
    ThrowUtils.throwIf(questionBank == null, ErrorCode.NOT_FOUND_ERROR);  
    //æŸ¥è¯¢é¢˜åº“å°è£…ç±»  
    QuestionBankVO questionBankV0= questionBankService.getQuestionBankVO(questionBank,request);  
    //æ˜¯å¦è¦å…³è”æŸ¥è¯¢é¢˜åº“ä¸‹çš„é¢˜ç›®åˆ—è¡¨  
    boolean needQuestionQueryList = questionbankqueryrequest.isNeedQueryQuestionList();  
    if(needQuestionQueryList  ) {  
        QuestionQueryRequest questionQueryRequest = new QuestionQueryRequest();  
        questionQueryRequest.setQuestionBankId(id);  
     Page<Question> questionPage = questionService.listQuestionByPage(questionQueryRequest);  
     questionBankV0.setQuestionPage(questionPage);  
    }  
    // è·å–å°è£…ç±»  
    return ResultUtils.success(questionBankV0);  
}
```
ä¸»è¦æ˜¯å¤ç”¨è¯·æ±‚ç±»ï¼Œå°è£…å“åº”ç±»
# ä¿®æ”¹é¢˜ç›®æ‰€å±é¢˜åº“æ¥å£
éœ€æ±‚ï¼šæ ¹æ®é¢˜ç›®idå’Œé¢˜åº“id ï¼Œä¿®æ”¹é¢˜ç›®æ‰€å±çš„é¢˜åº“
åˆ†æï¼šå¦‚æœé¢˜ç›®æ²¡æœ‰åŠ å…¥é¢˜åº“ï¼Œåˆ™åœ¨é¢˜åº“é¢˜ç›®å…³è”è¡¨åŠ ä¸€æ¡è®°å½•ï¼Œå¦‚æœé¢˜ç›®åŠ å…¥é¢˜åº“ï¼Œåˆ™å…³è”è¡¨æœ‰è®°å½•ï¼Œéœ€è¦å°†è®°å½•åˆ é™¤
è¡¨æ·»åŠ äº†é¢˜åº“idå’Œé¢˜ç›®idå”¯ä¸€æ€§çº¦æŸï¼Œä¸ç”¨æ‹…å¿ƒé‡å¤æ·»åŠ è„æ•°æ®ï¼Œåšå¥½å¼‚å¸¸å¤„ç†å°±è¡Œ
æ‰©å±•ï¼š
å¦‚æœè¦ç»™é¢˜åº“è¡¨å¢åŠ é¢˜ç›®æ€»æ•°å­—æ®µï¼Œä¿®æ”¹é¢˜ç›®æ‰€å±é¢˜åº“æ¥å£ï¼Œæ˜¯ï¼ŒåŒæ—¶æ›´æ–°é¢˜åº“è¡¨çš„é¢˜ç›®æ€»æ•°ï¼Œæ¶‰åŠå¤šè¡¨æ“ä½œï¼Œéœ€è¦ä½¿ç”¨äº‹åŠ¡å®ç°



# å‰ç«¯æ¨¡å—å¼€å‘
## ssræœåŠ¡ç«¯æ¸²æŸ“å‰ç«¯å¹³å°
éœ€æ±‚åˆ†æ
webå‰ç«¯æŠ€æœ¯é€‰å‹
å‰ç«¯åŸºç¡€é¡µé¢å¼€å‘
ç”¨æˆ·æ¨¡å—
ç®¡ç†é¡µé¢
1. [ ] éœ€æ±‚åˆ†æ
     - [ ] åŸºç¡€åŠŸèƒ½
     - [ ] ç”¨æˆ·æ¨¡å—
         - [ ] ç”¨æˆ·æ³¨å†Œ
         - [ ] ç”¨æˆ·ç™»å½•
         - [ ] ç®¡ç†å‘˜  ç®¡ç†ç”¨æˆ·-å¢åˆ æ”¹æŸ¥
- [ ] é¢˜åº“æ¨¡å—
   - [ ] æŸ¥çœ‹é¢˜åº“åˆ—è¡¨
   - [ ] æŸ¥çœ‹é¢˜åº“è¯¦æƒ…
   - [ ] ç®¡ç†å‘˜ ç®¡ç†é¢˜åº“-å¢åˆ æ”¹æŸ¥

- [ ] é¢˜ç›®æ¨¡å—
- [ ] æŸ¥çœ‹é¢˜ç›®åˆ—è¡¨
- [ ] æŸ¥çœ‹é¢˜ç›®è¯¦æƒ…
- [ ] ç®¡ç†å‘˜ ç®¡ç†é¢˜ç›®  å¢åˆ æ”¹æŸ¥ï¼ˆæŒ‰ç…§é¢˜åº“æŸ¥è¯¢é¢˜ç›®ï¼Œä¿®æ”¹é¢˜ç›®æ‰€å±é¢˜ç›®ç­‰


é«˜çº§åŠŸèƒ½(p1-p2)
- é¢˜ç›®æ‰¹é‡ç®¡ç†  p1
-   ç®¡ç†å‘˜ æ‰¹é‡å‘é¢˜åº“é‡Œæ·»åŠ é¢˜ç›®
- ç®¡ç†å‘˜  æ‰¹é‡ä»é¢˜åº“ç§»é™¤é¢˜ç›®
- ç®¡ç†å‘˜  æ‰¹é‡åˆ é™¤é¢˜ç›®
- åˆ†è¯æœç´¢é¢˜ç›®  p1
- ç”¨æˆ·åˆ·é¢˜è®°å½•æ—¥å†å›¾  p1
- è‡ªåŠ¨ç¼“å­˜çƒ­é—¨é¢˜ç›®  p2
- ç½‘ç»œæµé‡æ§åˆ¶å’Œç†”æ–­ p2
- åŠ¨æ€ip é»‘ç™½åå•è¿‡æ»¤ P2
- åŒç«¯ç™»å½•å†²çªæ£€æµ‹ p2
- åˆ†çº§é¢˜ç›®åçˆ¬è™«ç­–ç•¥ p2
-
![[Pasted image 20251028140951.png]]
-


> [!NOTE] 
> **å®¢æˆ·ç«¯æ¸²æŸ“ (CSR)**

- **å®šä¹‰**: æµè§ˆå™¨åœ¨æ¥æ”¶åˆ°æœåŠ¡å™¨å‘é€çš„æœ€å°åŒ–HTMLã€CSSå’ŒJavaScriptåï¼Œè´Ÿè´£ä¸‹è½½å¹¶æ‰§è¡ŒJavaScriptä»£ç ï¼Œç„¶åä»APIè·å–æ•°æ®ï¼Œå¹¶æ ¹æ®æ•°æ®åœ¨æµè§ˆå™¨ç«¯æ„å»ºDOMå¹¶æ›´æ–°é¡µé¢å†…å®¹ã€‚å¤§éƒ¨åˆ†æˆ–æ‰€æœ‰çš„é¡µé¢å†…å®¹éƒ½æ˜¯åœ¨ç”¨æˆ·çš„æµè§ˆå™¨ä¸­åŠ¨æ€ç”Ÿæˆçš„ã€‚
- **è¿‡ç¨‹**:
    1. ç”¨æˆ·é¦–æ¬¡è¯·æ±‚é¡µé¢ã€‚
    2. æœåŠ¡å™¨å‘é€ä¸€ä¸ªåŒ…å«å°‘é‡HTMLã€CSSå’Œä¸€ä¸ªJavaScriptæ–‡ä»¶çš„å“åº”ã€‚
    3. æµè§ˆå™¨ä¸‹è½½å¹¶åŠ è½½è¿™äº›èµ„æºã€‚
    4. æµè§ˆå™¨æ‰§è¡ŒJavaScriptæ–‡ä»¶ã€‚
    5. JavaScriptä»APIè·å–æ‰€éœ€æ•°æ®ã€‚
    6. JavaScriptæ ¹æ®æ•°æ®åŠ¨æ€æ„å»ºDOMï¼ˆDocument Object Modelï¼‰å¹¶æ¸²æŸ“é¡µé¢å†…å®¹ã€‚

> [!NOTE]
> **æœåŠ¡ç«¯æ¸²æŸ“ (SSR)**

- **å®šä¹‰**: æœåŠ¡å™¨åœ¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå°†æ•°æ®å¡«å……åˆ°HTMLæ¨¡æ¿ä¸­ï¼Œåœ¨æœåŠ¡å™¨ç«¯ç”Ÿæˆå®Œæ•´çš„HTMLé¡µé¢å­—ç¬¦ä¸²ï¼Œç„¶åå°†è¿™ä¸ªå·²åŒ…å«å†…å®¹çš„HTMLå“åº”å‘é€ç»™æµè§ˆå™¨ã€‚æµè§ˆå™¨æ¥æ”¶åˆ°çš„æ˜¯ä¸€ä¸ªå¯ä»¥ç›´æ¥æ˜¾ç¤ºï¼Œç”šè‡³éƒ¨åˆ†å¯äº¤äº’çš„é¡µé¢ã€‚
- **è¿‡ç¨‹**:
    1. ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­å‘èµ·é¡µé¢è¯·æ±‚ã€‚
    2. è¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨ã€‚
    3. æœåŠ¡å™¨æ ¹æ®è¯·æ±‚è·å–æ‰€éœ€æ•°æ®ã€‚
    4. æœåŠ¡å™¨ä½¿ç”¨è¿™äº›æ•°æ®ï¼Œç»“åˆé¡µé¢æ¨¡æ¿ï¼Œåœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“ç”Ÿæˆå®Œæ•´çš„HTMLå†…å®¹ã€‚
    5. æœåŠ¡å™¨å°†è¿™ä¸ªå®Œæ•´çš„HTMLå“åº”å‘é€å›æµè§ˆå™¨ã€‚
    6. æµè§ˆå™¨æ¥æ”¶åˆ°HTMLåï¼Œå¯ä»¥ç›´æ¥æ˜¾ç¤ºé¡µé¢å†…å®¹ã€‚
    7. ï¼ˆå¯é€‰ï¼‰æµè§ˆå™¨ä¸‹è½½å¹¶æ‰§è¡ŒJavaScriptæ–‡ä»¶ï¼Œå¯¹é¡µé¢è¿›è¡Œ"æ³¨æ°´" (Hydration)ï¼Œä½¿å…¶å˜å¾—å®Œå…¨å¯äº¤äº’ã€‚


> [!NOTE] ç»„ä»¶åº“
>
> å¼•å…¥antdç»„ä»¶åº“
> 

```
npm install antd --save
```



```
pnpm install @ant-design/nextjs-registry --save
```

> [!NOTE]
> https://procomponents.ant.design/components/form

> [!NOTE] nextjså¼€å‘è§„èŒƒ
> 

---
- çº¦å®šå¼è·¯ç”±
- è·¯ç”±ç»„ ï¼ˆï¼‰è™šæ‹Ÿç›®å½•
- åŠ¨æ€è·¯ç”±  []
- é™æ€èµ„æº ï¼Œpublicç›®å½•ä¸‹

> [!tip]
> ## æ–‡ä»¶ç»„ç»‡å½¢å¼


> [!important] 
> å…¨å±€é€šç”¨å¸ƒå±€


> [!NOTE] question
> ä¸ºä»€ä¹ˆreactçš„æœåŠ¡ç«¯æ¸²æŸ“ä¸èƒ½ç”¨use stateè¿™äº›é’©å­
> 
#### æœåŠ¡ç«¯è¿”å›çš„åªèƒ½æ˜¯æ¸²æŸ“å¥½çš„è®¡ç®—å¥½çš„æ•°æ®





> [!NOTE]
> å‰ç«¯å¼€å‘


> [!NOTE] ä»€ä¹ˆæ˜¯axios
> Axios æ˜¯ä¸€ä¸ªÂ [åŸºäº promise çš„](https://axios.nodejs.cn/docs/intro#)Â HTTP å®¢æˆ·ç«¯ï¼Œé€‚ç”¨äºÂ [`node.js`](https://axios.nodejs.cn/docs/intro#)Â å’Œæµè§ˆå™¨ã€‚å®ƒæ˜¯Â [åŒæ„çš„](https://axios.nodejs.cn/docs/intro#)ï¼ˆ= å®ƒå¯ä»¥åœ¨åŒä¸€ä»£ç åº“çš„æµè§ˆå™¨å’Œ Node.js ä¸­è¿è¡Œï¼‰ã€‚åœ¨æœåŠ¡å™¨ç«¯ï¼Œå®ƒä½¿ç”¨åŸç”Ÿçš„ node.jsÂ `http`Â æ¨¡å—ï¼Œè€Œåœ¨å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰ä¸Šï¼Œå®ƒä½¿ç”¨ XMLHttpRequestã€‚
> 
```
npm install axios
```


æ‚¨å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–°å»ºä¸€ä¸ªå®ä¾‹ã€‚

```
const instance = axios.create({
  baseURL: 'https://some-domain.com/api/',
  timeout: 1000,
  headers: {'X-Custom-Header': 'foobar'}
});
```




```
import axios from "axios"; 
// åˆ›å»º Axios ç¤ºä¾‹ 
const myAxios = axios.create({ 
baseURL: "http://localhost:8101", 
timeout: 10000,
 withCredentials: true, }); // åˆ›å»ºè¯·æ±‚æ‹¦æˆªå™¨ myAxios.interceptors.request.use( function (config) { // è¯·æ±‚æ‰§è¡Œå‰æ‰§è¡Œ
  return config; },
   function (error) { // å¤„ç†è¯·æ±‚é”™è¯¯
    return Promise.reject(error); }, ); 
    // åˆ›å»ºå“åº”æ‹¦æˆªå™¨ 
    myAxios.interceptors.response.use( 
    // 2xx å“åº”è§¦å‘ function (response) {
     // å¤„ç†å“åº”æ•°æ® 
     const { data } = response; 
     // æœªç™»å½•
      if (data.code === 40100) { // ä¸æ˜¯è·å–ç”¨æˆ·ä¿¡æ¯æ¥å£ï¼Œæˆ–è€…ä¸æ˜¯ç™»å½•é¡µé¢ï¼Œåˆ™è·³è½¬åˆ°ç™»å½•é¡µé¢ 
      if ( !response.request.responseURL.includes("user/get/login") && !window.location.pathname.includes("/user/login") ) { window.location.href = `/user/login?redirect=${window.location.href}` } } 
      else if (data.code !== 0) { 
      // å…¶ä»–é”™è¯¯ throw new Error(data.message ?? "æœåŠ¡å™¨é”™è¯¯"); } return data; }, 
      // é 2xx å“åº”è§¦å‘ function (error) {
       // å¤„ç†å“åº”é”™è¯¯ return Promise.reject(error); }, );
        export default myAxios
```

ä¼ ç»Ÿæƒ…å†µä¸‹ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½è¦å•ç‹¬ç¼–å†™ä»£ç ï¼Œå¾ˆéº»çƒ¦ã€‚ æ¨èä½¿ç”¨ OpenAPI å·¥å…·ï¼Œç›´æ¥è‡ªåŠ¨ç”Ÿæˆå³å¯ï¼š https://www.npmjs.com/package/@umijs/openapi


```ts

const { generateService } = require("@umijs/openapi"); generateService({ 
requestLibPath: "import request from '@/libs/request'", schemaPath: "http://localhost:8101/api/v2/api-docs", serversPath: "./src", })
```


```ts
> ts-node openapi.config.ts

(node:31824) [MODULE_TYPELESS_PACKAGE_JSON] Warning: Module type of file:///D:/mianshiya-lora/mianshihou-frontend/openapi.config.ts is not specified and it doesn't parse as CommonJS.
Reparsing as ES module because module syntax was detected. This incurs a performance overhead.
To eliminate this warning, add "type": "module" to D:\mianshiya-lora\mianshihou-frontend\package.json.
(Use `node --trace-warnings ...` to show where the warning was created)
[openAPI]: ğŸ’º å°† Swagger è½¬åŒ–ä¸º openAPI
[openAPI]: âœ… æˆåŠŸç”Ÿæˆ service æ–‡ä»¶

```


# å…¨å±€çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ
å…¨å±€çŠ¶æ€ç®¡ç† 
1ã€ä»€ä¹ˆæ˜¯å…¨å±€çŠ¶æ€ç®¡ç†ï¼Ÿ æ˜¯æŒ‡å¤šä¸ªé¡µé¢éœ€è¦å…±äº«æˆ–è€…è·Ÿè¸ªå˜åŒ–çš„å˜é‡ï¼Œå¯ä»¥æ”¾åˆ°å…¨å±€æ¥ç»Ÿä¸€ç»´æŠ¤ï¼Œè€Œä¸æ˜¯æ¯ä¸ªé¡µé¢åˆ†åˆ«ç»´æŠ¤ å’Œè·å–ã€‚ é€‚åˆä½œä¸ºå…¨å±€çŠ¶æ€çš„æ•°æ®ï¼šå·²ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼ˆæ¯ä¸ªé¡µé¢å‡ ä¹éƒ½è¦ç”¨ï¼‰ åœ¨ Vue ä¸­ï¼Œä¸»æµçš„çŠ¶æ€ç®¡ç†åº“æœ‰ Vuex å’Œ Piniaï¼›åœ¨ React é¡¹ç›®ä¸­ï¼Œä¸»æµçš„çŠ¶æ€ç®¡ç†åº“æ˜¯ Reduxï¼Œ æœ¬é¡¹ç›®ä¹Ÿå°†ä½¿ç”¨å®ƒã€‚
2ã€Redux åŸºæœ¬æ¦‚å¿µ React Redux å®˜æ–¹æ–‡æ¡£ï¼šhttps://react-redux.js.org/ 
Redux ä¸­æœ‰ä¸€äº›å¸¸ç”¨çš„æ ¸å¿ƒæ¦‚å¿µï¼Œä¸ç”¨ç†è§£ï¼Œç®€å•äº†è§£ä¸€ä¸‹å³å¯ã€‚ 
1ï¼‰Storeï¼šæ•´ä¸ªåº”ç”¨çŠ¶æ€ï¼ˆstateï¼‰çš„å®¹å™¨ï¼Œè´Ÿè´£å­˜å‚¨åº”ç”¨çš„çŠ¶æ€ï¼Œå¹¶æä¾›è®¿é—®çŠ¶æ€ã€æ´¾å‘ ï¼ˆdispatchï¼‰åŠ¨ä½œä»¥åŠæ³¨å†Œç›‘å¬å™¨ç­‰åŠŸèƒ½ã€‚ 
ï¼‰Actionï¼šä¸€ä¸ªæ™®é€šçš„ JavaScript å¯¹è±¡ï¼Œæè¿°äº†çŠ¶æ€å˜åŒ–çš„æ„å›¾ã€‚æ¯ä¸ª type å­—æ®µï¼Œè¡¨ç¤ºåŠ¨ä½œç±»å‹ã€‚ action å¿…é¡»åŒ…å«ä¸€ä¸ª ä¸€èˆ¬å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¼šç”¨ä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡ï¼ˆAction Typesï¼‰æ¥æ ‡è¯†ä¸åŒçš„åŠ¨ä½œç±»å‹ã€‚æ¯”å¦‚æ”¹å˜è®¡æ•°å™¨ éœ€è¦çš„ increment æˆ– decrementï¼š 1 2 const INCREMENT = 'INCREMENT'; const DECREMENT = 'DECREMENT'; 
è¿˜ä¼šç”¨ Action Creators åŠ¨ä½œåˆ›å»ºå™¨å‡½æ•°æ¥ç”Ÿæˆ action å¯¹è±¡ï¼Œæ¯”å¦‚ï¼š 1 2 3 4 5 6 7 const increment = () => ({ type: INCREMENT, });
const decrement = () => ({ type: DECREMENT, }); 
3ï¼‰Dispatchï¼šç”¨äºå‘é€ actionï¼Œè§¦å‘çŠ¶æ€æ›´æ–°ã€‚ 
4ï¼‰Reducerï¼šä¿—ç§°çŠ¶æ€å¤„ç†å™¨ï¼Œæ ¹æ®å½“å‰çŠ¶æ€å’Œä¼ å…¥çš„ action è¿”å›æ–°çš„çŠ¶æ€çš„å‡½æ•°ã€‚æ¯”å¦‚

```
const initialState = { count: 0 };
 function counterReducer(state = initialState, action) 
 {
  switch (action.type) { 
 case INCREMENT: return { ...state, count: state.count + 1 }; 
 case DECREMENT: return { ...state, count: state.count - 1 }; 
 default: return state; } }
```

æ›´å¤šæ ¸å¿ƒæ¦‚å¿µå¯ä»¥åœ¨å®˜æ–¹æ–‡æ¡£äº†è§£ï¼š
https://redux.js.org/tutorials/essentials/part-1-overview concepts

React Redux å®˜æ–¹å…¥é—¨æ–‡æ¡£ï¼šhttps://react-redux.js.org/tutorials/quick-start 
ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ TypeScriptï¼Œè¿˜è¦å‚è€ƒ TypeScript çš„å¿«é€Ÿå¯åŠ¨æ–‡æ¡£ï¼š
https://react redux.js.org/tutorials/typescript-quick-start ã€‚å¯¹äºæ–°æ‰‹ï¼Œä¸Šé¢ä¸¤ä¸ªæ–‡æ¡£æœ€å¥½æŒ‰é¡ºåºé˜…è¯»ã€‚

å…¶å®ä»¥å‰ Redux çš„ä½¿ç”¨æˆæœ¬è¿˜æ˜¯ç¨å¾®æœ‰ç‚¹é«˜çš„ï¼Œä½†å®˜æ–¹æä¾›äº† Redux Toolkitï¼Œå¯ä»¥ç®€åŒ–ä½¿ç”¨ Redux çš„å¼€å‘

```
pnpm install @reduxjs/toolkit react-redux
```


2ï¼‰é…ç½® Store

Store æ˜¯æ•´ä¸ªåº”ç”¨çŠ¶æ€ï¼ˆstateï¼‰çš„å®¹å™¨ï¼Œè´Ÿè´£å­˜å‚¨åº”ç”¨çš„çŠ¶æ€ï¼Œå¹¶æä¾›è®¿é—®çŠ¶æ€ã€æ´¾å‘ ï¼ˆdispatchï¼‰åŠ¨ä½œä»¥åŠæ³¨å†Œç›‘å¬å™¨ç­‰åŠŸèƒ½ã€‚

åœ¨é¡¹ç›®çš„ src ç›®å½•ä¸‹æ–°å»º stores ç›®å½•ï¼Œç”¨äºå­˜æ”¾æ‰€æœ‰çš„çŠ¶æ€ã€‚ç„¶ååœ¨ stores ç›®å½•ä¸‹æ–°å»º ndex.ts æ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„ Redux Storeï¼š




å…¨å±€æƒé™ç®¡ç†
	éœ€æ±‚ï¼šèƒ½å¤Ÿçµæ´»é…ç½®æ¯ä¸ªé¡µé¢æ‰€éœ€è¦çš„ç”¨æˆ·æƒé™ï¼Œç”±å…¨å±€æƒé™ç®¡ç†ç³»ç»Ÿè‡ªåŠ¨æ ¡éªŒå’Œæ‹¦æˆªï¼Œè€Œä¸éœ€è¦ åœ¨æ¯ä¸ªé¡µé¢ä¸­ç¼–å†™æƒé™æ ¡éªŒä»£ç ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚ 
	è¿˜è¦èƒ½å¤Ÿæ ¹æ®æƒé™æ§åˆ¶å¯¼èˆªèœå•çš„æ˜¾éšï¼Œåªæœ‰å…·æœ‰æƒé™çš„èœå•ï¼Œæ‰å¯¹ç”¨æˆ·å¯è§ã€‚ å®ç°æ–¹æ¡ˆ 
	1. åœ¨è·¯ç”±é…ç½®æ–‡ä»¶ï¼Œ å®šä¹‰æŸä¸ªè·¯ç”±çš„è®¿é—®æƒé™ã€‚ç”±äº Next.js é¡¹ç›®æ˜¯çº¦å®šå¼è·¯ç”±ï¼Œåªæœ‰æˆ‘ä»¬è‡ªå®š ä¹‰çš„èœå•é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥åœ¨èœå•é…ç½®æ–‡ä»¶ä¸­å®šä¹‰æƒé™ã€‚
	2. æ¯æ¬¡è®¿é—®é¡µé¢æ—¶ï¼Œæ ¹æ®ç”¨æˆ·è¦è®¿é—®é¡µé¢çš„è·¯ç”±æƒé™ä¿¡æ¯ï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰å¯¹åº”çš„è®¿é—®æƒé™ï¼Œå¹¶ è¿›è¡Œç›¸åº”çš„æ‹¦æˆªå¤„ç†ã€‚è¿™æ˜¯ä¸€ä¸ªå…¨å±€é€»è¾‘ï¼Œå¯ä»¥åœ¨é¡¹ç›®æ ¹å¸ƒå±€ app/layout.tsx ä¸­æ·»åŠ ã€‚ 3. å¯¼èˆªæ å±•ç¤ºèœå•æ—¶ï¼Œå¯ä»¥è¿‡æ»¤æ‰ç™»å½•ç”¨æˆ·æ²¡æœ‰æƒé™çš„èœå•é¡¹ï¼Œä»è€Œå®ç°æ ¹æ®æƒé™æ§åˆ¶å¯¼èˆªèœå• çš„æ˜¾éš
è¿˜æœ‰å…¶ä»–å®ç°æƒé™æ ¡éªŒçš„æ–¹æ³•ï¼Œæ¯”å¦‚ä½¿ç”¨é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰åœ¨å®¢æˆ·ç«¯è¿›è¡Œæƒé™æ ¡éªŒï¼Œè¿™ç§æ–¹æ³•ä¼šæ›´ çµæ´»ã€‚



é€šç”¨ç»„ä»¶markdown ç¼–è¾‘å™¨ç»„ä»¶
æ¨èçš„ Md ç¼–è¾‘å™¨ï¼šhttps://github.com/bytedance/bytemd




# æ‰©å±•åŠ å…¥é¢˜åº“è®°å½•åŠŸèƒ½
## æœ€ä¼ ç»Ÿæ–¹å¼ ï¼Œæ•°æ®åº“è®¾è®¡ä¸€ä¸ªè¡¨ï¼Œç»‘å®šç”¨æˆ·idï¼Œä¸ä»–çš„åˆ·é¢˜æ—¥æœŸå…³ç³»
- æ¯æ¬¡é€šè¿‡æŸ¥è¯¢ï¼Œç­›é€‰æ¥æŸ¥è¯¢è¯¥ç”¨æˆ·åˆ·é¢˜æ—¥æœŸ
- ä½†æ˜¯å¦‚æœæ”¯æŒçš„ç”¨æˆ·å¤šäº†
-  ä¸€ä¸ªç”¨æˆ·ä¸€å¹´360å­˜çš„æ•°æ®ï¼Œç”¨æˆ·å¤šäº†çš„æƒ…å†µå‘¢

## å¼•å…¥redis åˆ†å¸ƒå¼ç¼“å­˜ã€‚åŸºäºå†…å­˜çš„é”®å€¼å­˜å‚¨ï¼Œ è¿˜æœ‰æœ¬åœ°å¼ç¼“å­˜ï¼Œè§£å†³ï¼Œ  é€šè¿‡ä»user:signins:{å¹´ä»½}ï¼š{æ—¥æœŸ}ä¼˜åŒ–å†…å­˜èŠ‚çœ

- å­˜å‚¨åˆ·é¢˜çŠ¶æ€ç®€å•æ–¹å¼
- int  0   | 1   ä½†æ˜¯ä¸€ä¸ªå­—èŠ‚4ä½   ä¸€ä¸ªå­—èŠ‚8ä½  ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰32ä½ï¼Œï¼Œä¸€å¹´å‘¢ã€‚å­˜å‚¨é‡ä¹ŸæŒºå¤§

## è¿˜æœ‰ä»€ä¹ˆåŠæ³•æ¥ä¼˜åŒ–è¿™ä¸ªå­˜å‚¨çš„æ•°æ®å‘¢ï¼Œ -> bitmap

- å°†æ•°æ®çš„çŠ¶æ€ä»ä¹‹å‰çš„00000000  -> 0/1 ä¼˜åŒ–ä¸º1ä½ï¼Œ   
- æˆåŠŸä»¥ä½æˆæœ¬é€ å‡ºæ”¯æŒåƒä¸‡çº§ç”¨æˆ·è®¿é—®ç³»ç»Ÿ

æ¶‰åŠ  çŠ¶æ€çš„ï¼Œ0/1çš„åŠŸèƒ½å­˜å‚¨éƒ½å¯ä»¥è€ƒè™‘bitsetæ•°æ®ç»“æ„æ¥å­˜å‚¨
![[Pasted image 20251105134109.png]]
æ”¯æŒå†…å­˜é‡å¾ˆå°ï¼Œéœ€è¦ç†Ÿæ‚‰ä½å›¾æ“ä½œä¸€ç‚¹


#### åŸºäºæ€§èƒ½è€ƒè™‘ï¼Œä½¿ç”¨redisæ¥å­˜å‚¨ç”¨æˆ·çš„ç­¾åˆ°è®°å½•
#### åŸºäºç©ºé—´çš„è§’åº¦è€ƒè™‘ï¼Œæˆ‘ä»¬ä½¿ç”¨bitmap | bitsetæ¥å­˜å‚¨ç”¨æˆ·ç­¾åˆ°è®°å½• -> ç”¨ä½æ¥ä¼˜åŒ–å„ç±»çš„è¯·æ±‚å’Œè¿”å›æ•°æ®çš„è¡¨ç¤ºï¼Œå› ä¸ºæ˜¯ç”¨åœ¨çŠ¶æ€è¡¨ç¤ºçš„ 0/1


### ä¼˜åŒ–å°ç»“
- å‡å°‘ç½‘ç»œè°ƒç”¨æ¬¡æ•°
- å‡å°‘æ¥å£ä¼ è¾“æ•°æ®çš„ä½“ç§¯
- å‡å°‘å¾ªç¯å’Œä½“ç§¯
- é€šè¿‡å®¢æˆ·ç«¯è®¡ç®—å’Œå‡å°‘æœåŠ¡ç«¯çš„å‹åŠ›

```java
    @Override  
    public List<Integer> getUserSignInRecord(long userId, Integer year) {  
        if (year == null) {  
            LocalDate date = LocalDate.now();  
            year = date.getYear();  
        }  
        String key = RedissonConstant.getUSER_SIGN_IN_REDIS_KEY_PREFIX(year, userId);  
        //è·å–redisçš„bitmap  
  
        RBitSet signInBitSet = redissonClient.getBitSet(key);  
  
        //æ€§èƒ½ä¼˜åŒ– ï¼ŒåŠ è½½Bitsetåˆ°å†…å­˜ï¼Œé¿å…åç«¯è¯»å–æ—¶ï¼Œå‘é€å¤šæ¬¡è¯·æ±‚  
        BitSet bitSet = signInBitSet.asBitSet();  
        //æ„é€ è¿”å›ç»“æœ  
//        Map<LocalDate, Boolean> result = new LinkedHashMap<>();  
        //ç»Ÿè®¡ç­¾åˆ°çš„æ—¥æœŸåˆ—è¡¨  
        List<Integer> dayList = new ArrayList<>();  
        //è·å–å½“å‰å¹´ä»½çš„æ€»å¤©æ•°  
        int totalDays = Year.of(year).length();  
        //ä»ç´¢å¼•0å¼€å§‹æŸ¥æ‰¾ä¸‹ä¸€ä¸ªè¢«è®¾ç½®ä¸º1çš„ä½  
        int index = bitSet.nextSetBit(0);  
        while (index >= 0) {  
            dayList.add(index);  
            //æŸ¥æ‰¾ä¸‹ä¸€ä¸ªè¢«è®¾ç½®ä¸º1çš„ä½  
            index = bitSet.nextSetBit(index + 1);  
        }  
//        //è·å–æ¯å¤©çš„ç­¾åˆ°çŠ¶æ€  
//        for (int dayOfYear = 1; dayOfYear <= totalDays; dayOfYear++) {  
//  
//            //è·å–value:å½“å¤©æ˜¯å¦æœ‰åˆ·é¢˜  
//            boolean hasRecord = bitSet.get(dayOfYear);  
//           //ç»“æœæ”¾å…¥map  
//            result.put(currentDate, hasRecord);  
//  
//            if( hasRecord) {  
//                //å¦‚æœå½“å‰å¤©ç­¾åˆ°äº†  
//                dayList.add(dayOfYear);  
//            }  
//        }  
        return dayList;  
    }  
    //è¿”å›å€¼ä¼˜åŒ–ï¼Œè®¡ç®—æ—¶é—´è€—æ—¶ï¼Œä¼ è¾“æ•°æ®å¤šï¼Œæ•ˆç‡ä½  
}

```

ä¸æ–­ä¼˜åŒ–é€Ÿåº¦ï¼Œå°†ä»634kb -> 35b


## æ‰©å±•åŠŸèƒ½å‰ç«¯
### ç”¨æˆ·ä¸­å¿ƒé¡µé¢çš„ssr 
-  é€šè¿‡useid è·å–åŸºç¡€ä¿¡æ¯ï¼Œå†åˆ°å®¢æˆ·ç«¯æºå¸¦çš„cookieæŸ¥çœ‹ç™»å½•ç”¨æˆ·å¯è§çš„ä¿¡æ¯
## ç”¨æˆ·ä¸­å¿ƒé¡µé¢æ·»åŠ æƒé™æ ¡éªŒ
- é€šè¿‡menué…ç½®èœå•é¡¹
## å¦‚æœç­¾åˆ°æˆåŠŸï¼Œå¯ä»¥ä¿å­˜åˆ°localstorgeä½ç½®ï¼Œé˜²æ­¢æ¯æ¬¡åˆ·é¢˜é‡å¤è¯·æ±‚



## æ‰©å±•
- redis çš„bitmapè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œç”¨å•æ¬¡ä»»åŠ¡æˆ–è€…å®šæ—¶ä»»åŠ¡å»è®°å½•æ—¶é—´ï¼Œæ¯”å¦‚è¯´ä¸€å¹´åå°±iç›´æ¥å°†ä¸Šä¸€å¹´çš„å­˜åˆ°æ•°æ®åº“ç›´æ¥æ¸…æ¥šæ‰å°±å°±è¡Œ
-
#### æŒ‰æœˆä»½æŸ¥çœ‹åˆ·é¢˜è®°å½•ï¼Œ   ç»™redisåç«¯çš„bitmap keyåŠ å¤šä¸ªæœˆä»½å±‚çº§ã€‚ï¼Œå‰ç«¯ä½¿ç”¨ant designçš„æ—¥å†ç»„ä»¶

# åç«¯æ•´åˆelastaicsearch æœåŠ¡

## elastaicssearch  æ•´åˆ
 ## javaï¼Œphpï¼Œnode,ç­‰éƒ½æœ‰å®¢æˆ·ç«¯ç»“åˆ
## å’±ä»¬springboot 2*nç‰ˆæœ¬ï¼Œ  estaicsearch æ”¯æŒ 7*ç‰ˆæœ¬ kibana ä¹Ÿåº”è¯¥ä½¿ç”¨ 7*ç‰ˆæœ¬çš„ï¼Œspring 2* n æ—¶java8 çš„ã€‚springboot -> spring data....->elastaicsearch->kibana  

> 
> https://www.elastic.co/docs/release-notes/elasticsearch
> https://www.elastic.co/docs/release-notes/elasticsearch
> https://www.elastic.co/guide/en/kibana/7.17/windows.html



> [!NOTE] java å®¢æˆ·ç«¯æ•´åˆelasticsearch
>    


---

### esæ’ä»¶ ä¸­æ–‡åˆ†è¯å™¨
### elasticsearch-analysis-ik
```
\elasticsearch-plugin.bat install https://release.infinilabs.com/analysis-ik/stable/elasticsearch-analysis-ik-7.17.29.zip
```

---
https://github.com/infinilabs/analysis-ik
1.create a index

curl -XPUT http://localhost:9200/index

---

2.create a mapping

```
curl -XPOST http://localhost:9200/index/_mapping -H 'Content-Type:application/json' -d'
{
        "properties": {
            "content": {
                "type": "text",
                "analyzer": "ik_max_word",
                "search_analyzer": "ik_smart"
            }
        }

}'

```

---

3.index some docs

```
curl -XPOST http://localhost:9200/index/_create/1 -H 'Content-Type:application/json' -d'
{"content":"ç¾å›½ç•™ç»™ä¼Šæ‹‰å…‹çš„æ˜¯ä¸ªçƒ‚æ‘Šå­å—"}
'
```

---

4.query with highlighting
```

curl -XPOST http://localhost:9200/index/_search  -H 'Content-Type:application/json' -d'
{
    "query" : { "match" : { "content" : "ä¸­å›½" }},
    "highlight" : {
        "pre_tags" : ["<tag1>", "<tag2>"],
        "post_tags" : ["</tag1>", "</tag2>"],
        "fields" : {
            "content" : {}
        }
    }
}
'
```

---

Result

```
{
    "took": 14,
    "timed_out": false,
    "_shards": {
        "total": 5,
        "successful": 5,
        "failed": 0
    },
    "hits": {
        "total": 2,
        "max_score": 2,
        "hits": [
            {
                "_index": "index",
                "_type": "fulltext",
                "_id": "4",
                "_score": 2,
                "_source": {
                    "content": "ä¸­å›½é©»æ´›æ‰çŸ¶é¢†äº‹é¦†é­äºšè£”ç”·å­æªå‡» å«ŒçŠ¯å·²è‡ªé¦–"
                },
                "highlight": {
                    "content": [
                        "<tag1>ä¸­å›½</tag1>é©»æ´›æ‰çŸ¶é¢†äº‹é¦†é­äºšè£”ç”·å­æªå‡» å«ŒçŠ¯å·²è‡ªé¦– "
                    ]
                }
            },
            {
                "_index": "index",
                "_type": "fulltext",
                "_id": "3",
                "_score": 2,
                "_source": {
                    "content": "ä¸­éŸ©æ¸”è­¦å†²çªè°ƒæŸ¥ï¼šéŸ©è­¦å¹³å‡æ¯å¤©æ‰£1è‰˜ä¸­å›½æ¸”èˆ¹"
                },
                "highlight": {
                    "content": [
                        "å‡æ¯å¤©æ‰£1è‰˜<tag1>ä¸­å›½</tag1>æ¸”èˆ¹ "
                    ]
                }
            }
        ]
    }
}

```

---

```
GET _analyze
{
  "analyzer": "ik_max_word",
  "text":"é±¼çš®æ˜¯ä¸ªå¥½å­¦ç”Ÿ"
}
```



---

### è®¾è®¡es ç´¢å¼•

```
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚        ç”¨æˆ· / åº”ç”¨å±‚       â”‚
                â”‚  Web / App / åå°ç³»ç»Ÿ     â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            æ•°æ®è®¿é—®å±‚                                 â”‚
â”‚                                                                        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     â”‚   MySQL       â”‚           â”‚   MongoDB        â”‚          â”‚ Elasticsearch   â”‚
â”‚     â”‚ï¼ˆå…³ç³»å‹æ•°æ®åº“ï¼‰â”‚           â”‚ï¼ˆæ–‡æ¡£å‹æ•°æ®åº“ï¼‰   â”‚          â”‚ï¼ˆæœç´¢ + åˆ†æå¼•æ“ï¼‰â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚            â”‚                                â”‚                           â”‚
â”‚            â”‚ç»“æ„åŒ–æ•°æ®ï¼ˆè¡¨ï¼‰                â”‚åŠç»“æ„åŒ–æ•°æ®ï¼ˆæ–‡æ¡£ï¼‰        â”‚ç´¢å¼•åŒ–æ•°æ®ï¼ˆå€’æ’è¡¨ï¼‰â”‚
â”‚            â”‚                                â”‚                           â”‚
â”‚            â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€ æ•°æ®åŒæ­¥ï¼ˆETLï¼‰ â”€â”€â”€â”€>â”‚â”€â”€â†’ åŒæ­¥åˆ° ES ä¾›æ£€ç´¢         â”‚
â”‚            â”‚                                â”‚                           â”‚
â”‚            â–¼                                â–¼                           â–¼
â”‚     å¼ºäº‹åŠ¡ã€é«˜ä¸€è‡´æ€§                çµæ´»ç»“æ„ã€é«˜æ‰©å±•æ€§         å…¨æ–‡æœç´¢ã€èšåˆåˆ†æ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


|ç³»ç»Ÿ|æ ¸å¿ƒå®šä½|å­˜å‚¨æ•°æ®æ ¼å¼|æœ€æ“…é•¿çš„äº‹|
|---|---|---|---|
|**MySQL**|å…³ç³»å‹æ•°æ®åº“ï¼ˆRDBMSï¼‰|è¡¨ç»“æ„ï¼ˆRow/Columnï¼‰|äº‹åŠ¡ã€å…³ç³»ã€ä¸šåŠ¡ä¸€è‡´æ€§|
|**MongoDB**|æ–‡æ¡£å‹ NoSQL æ•°æ®åº“|BSONï¼ˆJSON æ‰©å±•ï¼‰|çµæ´»ç»“æ„ã€å¿«é€Ÿå¼€å‘|
|**Elasticsearch**|æœç´¢ä¸åˆ†æå¼•æ“|JSONï¼ˆå€’æ’ç´¢å¼•ï¼‰|å…¨æ–‡æ£€ç´¢ã€èšåˆåˆ†æã€æ—¥å¿—|


## æ•°æ®æµé€»è¾‘å›¾
```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   ç”¨æˆ·æ“ä½œ    â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   åº”ç”¨æœåŠ¡ (Java/Spring) â”‚
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ å†™å…¥ä¸šåŠ¡æ•°æ® â†’ MySQL / MongoDB
            â”‚
            â””â”€â”€â”€â”€â†’ å¼‚æ­¥åŒæ­¥ â†’ Elasticsearchï¼ˆç”¨äºæœç´¢ä¸åˆ†æï¼‰

```


##### - **ä¸šåŠ¡ç³»ç»Ÿä¸»åº“ï¼š** å­˜åœ¨ MySQL æˆ– MongoDBï¼›
    
##### - **ESï¼š** ä»ä¸»åº“åŒæ­¥æ•°æ®ï¼ˆé€šè¿‡ Logstash / Kafka / ç¨‹åºï¼‰ï¼›
    
##### - ç”¨æˆ·æœç´¢æ—¶ï¼Œç›´æ¥æŸ¥ ESï¼ˆå¿« + æ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼‰ï¼›
    
##### - ç”¨æˆ·ç‚¹å‡»å…·ä½“å†…å®¹ï¼Œå†ä»æ•°æ®åº“å–è¯¦æƒ…ï¼ˆä¿è¯å‡†ç¡®ï¼‰ã€‚


### æŸ¥è¯¢æœºåˆ¶å¯¹æ¯”å›¾

```
[ MySQL / MongoDB æŸ¥è¯¢ ]
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ æ¡ä»¶ï¼šname = "AIå­¦ä¹ è·¯çº¿"         â”‚
 â”‚ â†’ ç´¢å¼• BTree æ‰«æå­—æ®µ             â”‚
 â”‚ â†’ è¿”å›å®Œå…¨åŒ¹é…çš„è®°å½•              â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[ Elasticsearch æŸ¥è¯¢ ]
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ æŸ¥è¯¢ï¼šmatch content: "AI å­¦ä¹ "     â”‚
 â”‚ â†’ åˆ†è¯ ("AI", "å­¦ä¹ ")              â”‚
 â”‚ â†’ å€’æ’ç´¢å¼•æŸ¥è¯å¯¹åº”çš„æ–‡æ¡£IDåˆ—è¡¨     â”‚
 â”‚ â†’ è®¡ç®—ç›¸å…³åº¦åˆ†å€¼ _score            â”‚
 â”‚ â†’ æ’åºåè¿”å›â€œæœ€ç›¸å…³â€çš„ç»“æœ         â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

| åŠŸèƒ½                                | MySQL             | MongoDB     | Elasticsearch |     |
| --------------------------------- | ----------------- | ----------- | ------------- | --- |
| æ•°æ®ç»“æ„                              | ä¸¥æ ¼è¡¨ç»“æ„             | åŠ¨æ€ JSON     | åŠ¨æ€ JSONï¼ˆç´¢å¼•ä¸ºä¸»ï¼‰ |     |
| äº‹åŠ¡                                | âœ… å¼ºäº‹åŠ¡ (ACID)      | âœ… æ”¯æŒå¤šæ–‡æ¡£äº‹åŠ¡   | âš ï¸ å•æ–‡æ¡£åŸå­      |     |
| æŸ¥è¯¢æ–¹å¼                              | SQL               | JSON æŸ¥è¯¢     | DSL æŸ¥è¯¢        |     |
| æŸ¥è¯¢ç›®æ ‡                              | ç²¾ç¡®æŸ¥è¯¢              | ç²¾ç¡® + æ¨¡ç³Š     | ç›¸å…³åº¦æœç´¢         |     |
| æœç´¢åŠŸèƒ½                              | LIKE å¼±åŒ¹é…          | æ”¯æŒæ­£åˆ™        | âœ… å¼ºå¤§å…¨æ–‡æ£€ç´¢      |     |
| èšåˆåˆ†æ                              | group by          | Aggregation | âœ… é«˜çº§èšåˆåˆ†æ      |     |
| å¯æ‰©å±•æ€§                              | å‚ç›´æ‰©å±•              | æ°´å¹³æ‰©å±•        | âœ… åˆ†å¸ƒå¼å¤©ç”Ÿæ”¯æŒ     |     |
| é€‚åˆåœºæ™¯                              | è®¢å•ã€è´¦å•ã€å…³ç³»å‹æ•°æ®       | æ–‡æ¡£ç±»ã€çµæ´»ä¸šåŠ¡    | æœç´¢ã€æ—¥å¿—ã€æ¨è      |     |


---
```
| ç³»ç»Ÿ                                | ä½ åº”è¯¥æ€ä¹ˆæƒ³å®ƒï¼Ÿ          |             |               |     |
| --------------------------------- | ----------------- | ----------- | ------------- | --- |
| ğŸ§± **MySQL** â†’ ç¨³å®šå­˜å‚¨ä¸šåŠ¡æ•°æ®           | ä¼ ç»Ÿæ ¸å¿ƒæ•°æ®åº“ï¼Œé‡äº‹åŠ¡ã€‚      |             |               |     |
| ğŸ“¦ **MongoDB** â†’ å¿«é€Ÿå¼€å‘çµæ´»ç»“æ„         | éç»“æ„åŒ–æ–‡æ¡£ç³»ç»Ÿï¼Œçµæ´»æ˜“æ‰©å±•ã€‚   |             |               |     |
| ğŸ” **Elasticsearch** â†’ æœç´¢ & åˆ†æåŠ é€Ÿå™¨ | è®©æœç´¢ã€æ¨¡ç³ŠåŒ¹é…ã€èšåˆåˆ†æé£èµ·æ¥ã€‚ |             |               |     |
```

```css

[ç”¨æˆ·è¯·æ±‚]
     â”‚
     â–¼
[Spring Boot åº”ç”¨]
     â”‚
     â”œâ”€â”€ MySQLï¼ˆæ ¸å¿ƒä¸šåŠ¡ï¼‰
     â”œâ”€â”€ MongoDBï¼ˆéç»“æ„åŒ–æ–‡æ¡£ï¼‰
     â””â”€â”€ Elasticsearchï¼ˆæœç´¢ / æ—¥å¿—åˆ†æï¼‰

```

- **ç”µå•†**ï¼šMySQL å­˜è®¢å•ï¼ŒMongoDB å­˜å•†å“è¯¦æƒ… JSONï¼ŒES æä¾›æœç´¢ï¼›
    
- **åšå®¢ç³»ç»Ÿ**ï¼šMongoDB å­˜æ–‡ç« ï¼ŒES æä¾›å…¨æ–‡æœç´¢ï¼›
    
- **æ—¥å¿—å¹³å°ï¼ˆELKï¼‰**ï¼šFilebeat â†’ Logstash â†’ ES â†’ Kibana å¯è§†åŒ–
![[Pasted image 20251106175430.png]]




```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Controller å±‚         â”‚ â† è´Ÿè´£æ¥æ”¶è¯·æ±‚ã€è¿”å›ç»“æœï¼ˆAPIï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Service å±‚           â”‚ â† å†™ä¸šåŠ¡é€»è¾‘ï¼Œæ¯”å¦‚ç”¨æˆ·æ³¨å†Œã€ä¸‹å•
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            DAO å±‚             â”‚ â† æ“ä½œæ•°æ®åº“ï¼ˆSQL/ES/Mongoï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```
```
|å±‚çº§|ä¸»è¦èŒè´£|ä¸¾ä¾‹|
|---|---|---|
|Controller|å¤„ç† HTTP è¯·æ±‚|`/api/user/login`|
|Service|å†™ä¸šåŠ¡é€»è¾‘|æ ¡éªŒå¯†ç ã€ç”Ÿæˆ token|
|DAO|æ“ä½œæ•°æ®åº“|ä»æ•°æ®åº“æŸ¥ç”¨æˆ·|
```

---

```
|è§’è‰²|å¯¹åº”å±‚|ä½œç”¨|
|---|---|---|
|å‰å°æ¥å¾…|Controller|æ¥æ”¶å®¢æˆ·è¯·æ±‚|
|åº—é•¿|Service|å†³å®šæ€ä¹ˆå¤„ç†ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰|
|ä»“åº“ç®¡ç†å‘˜|DAO|ä»ä»“åº“ï¼ˆæ•°æ®åº“ï¼‰å–è´§ / å­˜è´§|
```

---
![[Pasted image 20251106181519.png]]




![[Pasted image 20251106224111.png]]



---

esï¼šæ‰©å±•
![[Pasted image 20251106221953.png]]![[Pasted image 20251106222149.png]]


---
![[Pasted image 20251106222225.png]]

![[Pasted image 20251106222321.png]]



![[Pasted image 20251106222331.png]]



![[Pasted image 20251106222251.png]]


### é€šç”¨æ‰¹å¤„ç†æ“ä½œ

### é•¿äº‹åŠ¡å¤„ç†å’Œaop ä»£ç†å¯¹è±¡è°ƒç”¨ç”Ÿæ•ˆäº‹åŠ¡æ“ä½œçš„æƒé™å’Œå›æ»š
```java

@Override  
public void batchAddQuestionToBank(List<Long> questionIdList, long questionBankId, User loginUser) {  
    //å‚æ•°æ ¡éªŒ  
  
    ThrowUtils.throwIf(questionIdList == null, ErrorCode.PARAMS_ERROR, "é¢˜ç›®åˆ—è¡¨idä¸èƒ½ä¸ºç©º");  
    ThrowUtils.throwIf(questionBankId <= 0, ErrorCode.PARAMS_ERROR, "é¢˜åº“idéæ³•");  
    ThrowUtils.throwIf(loginUser == null, ErrorCode.NOT_LOGIN_ERROR);  
    //æ£€æŸ¥é¢˜ç›®idæ˜¯å¦å­˜åœ¨  
    List<Question> questionList = questionService.listByIds(questionIdList);  
    //åˆæ³•çš„é¢˜ç›®id åˆ—è¡¨  
    List<Long> validQuestiongList = questionList.stream()  
            .map(Question::getId)  
            .collect(Collectors.toList());  
    //æ£€æŸ¥é‚£äº›é¢˜ç›®è¿˜ä¸å­˜åœ¨äºé¢˜åº“é‡Œ,åªæ‰¾å‡ºä¸å­˜åœ¨é¢˜åº“åˆ—è¡¨çš„é¢˜ç›®ï¼Œé¿å…é‡å¤æ’å…¥  
    LambdaQueryWrapper<QuestionBankQuestion> LambdaQueryWrapper = Wrappers.lambdaQuery(QuestionBankQuestion.class)  
            .eq(QuestionBankQuestion::getQuestionBankId, questionBankId)  
            .notIn(QuestionBankQuestion::getQuestionId, validQuestiongList);  
    List<QuestionBankQuestion> noExistQuestionList = this.list(LambdaQueryWrapper);  
    validQuestiongList = noExistQuestionList.stream()  
            .map(QuestionBankQuestion::getId)  
            .collect(Collectors.toList());  
  
    ThrowUtils.throwIf(CollUtil.isEmpty(validQuestiongList), ErrorCode.PARAMS_ERROR, "æ‰€æœ‰é¢˜ç›®éƒ½å·²ç»å­˜åœ¨äºé¢˜åº“ä¸­");  
  
  
    //æ£€æŸ¥é¢˜åº“æ˜¯å¦å­˜åœ¨  
    QuestionBank questionBank = questionBankService.getById(questionBankId);  
    ThrowUtils.throwIf(questionBank == null, ErrorCode.PARAMS_ERROR, "é¢˜åº“ä¸å­˜åœ¨");  
    //æ‰§è¡Œæ’å…¥æ“ä½œ  
    //åˆ†æ‰¹å¤„ç†ï¼Œé¿å…é•¿äº‹åŠ¡ï¼Œå‡è®¾æ¯æ¬¡å¤„ç†1000æ¡æ•°æ®  
    int batchSize = 1000;  
    int totalQuestionListSize = validQuestiongList.size();  
  
    for (int i = 0; i < totalQuestionListSize; i++) {  
        //ç”Ÿæˆæ¯æ‰¹æ¬¡çš„æ•°æ®  
        List<Long> subList;  
        subList = validQuestiongList.subList(i, Math.min(i + batchSize, totalQuestionListSize));  
        List<QuestionBankQuestion> questionBankQuestions = subList.stream()  
                .map(questionId -> {  
                    QuestionBankQuestion questionBankQuestion = new QuestionBankQuestion();  
                    questionBankQuestion.setQuestionBankId(questionBankId);  
                    questionBankQuestion.setQuestionId(questionId);  
                    questionBankQuestion.setUserId(loginUser.getId());  
                    return questionBankQuestion;  
                })  
                .collect(Collectors.toList());  
  
        //ä½¿ç”¨äº‹åŠ¡å¤„ç†æ¯æ‰¹æ•°æ® ,ä»£ç†å¯¹è±¡ä½¿ç”¨ï¼Œä¸ç„¶äº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆï¼Œä¸èƒ½ç›´æ¥è°ƒç”¨this,ä¸ç„¶ä¸ç”Ÿæ•ˆ  
        //è·å–ä»£ç†å¯¹è±¡  
        QuestionBankQuestionServiceImpl questionBankQuestionService = (QuestionBankQuestionServiceImpl) AopContext.currentProxy();  
        questionBankQuestionService.batchAddQuestionToBankInner(questionBankQuestions);  
    }  
  
  
}  
  
/**  
 * æ‰¹é‡æ·»åŠ é¢˜ç›®åˆ°é¢˜åº“äº‹åŠ¡,ä»…ä¾›å†…éƒ¨ä½¿ç”¨  
 *  
 * @param questionBankQuestions  
 */  
@Override  
@Transactional(rollbackFor = Exception.class)  
public void batchAddQuestionToBankInner(List<QuestionBankQuestion> questionBankQuestions) {  
  
  
    for (QuestionBankQuestion questionBankQuestion : questionBankQuestions) {  
  
  
        Long questionId = questionBankQuestion.getQuestionId();  
        Long questionBankId = questionBankQuestion.getQuestionBankId();  
        try {  
  
  
            boolean result = this.save(questionBankQuestion);  
            ThrowUtils.throwIf(!result, ErrorCode.PARAMS_ERROR, "å‘é¢˜åº“æ·»åŠ é¢˜ç›®å¤±è´¥");  
        } catch (DataIntegrityViolationException e) {  
            log.error("æ•°æ®åº“å”¯ä¸€é”®å†²çªæˆ–è¿åå…¶ä»–å®Œæ•´æ€§çº¦æŸ, é”™è¯¯ä¿¡æ¯: {}, é¢˜ç›®id: {}, é¢˜åº“id: {}", e.getMessage(), questionId, questionBankId);  
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "é¢˜ç›®å·²å­˜åœ¨äºè¯¥é¢˜åº“ï¼Œæ— æ³•é‡å¤æ·»åŠ ");  
        } catch (DataAccessException e) {  
            log.error("æ•°æ®åº“è¿æ¥é—®é¢˜ã€äº‹åŠ¡é—®é¢˜ç­‰å¯¼è‡´æ“ä½œå¤±è´¥, é”™è¯¯ä¿¡æ¯: {}", e.getMessage());  
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "æ•°æ®åº“æ“ä½œå¤±è´¥");  
        } catch (Exception e) {  
            // æ•è·å…¶ä»–å¼‚å¸¸ï¼Œåšé€šç”¨å¤„ç†  
            log.error("æ·»åŠ é¢˜ç›®åˆ°é¢˜åº“æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼Œé”™è¯¯ä¿¡æ¯: {}", e.getMessage());  
            throw new BusinessException(ErrorCode.OPERATION_ERROR, "å‘é¢˜åº“æ·»åŠ é¢˜ç›®å¤±è´¥");  
        }  
    }  
}
```

# ç®¡ç†åŠŸèƒ½æ‰©å±•

## é¢˜ç›®æ‰¹é‡ç®¡ç†
## è‡ªåŠ¨ç¼“å­˜çƒ­é—¨é¡¹ç›® 

### é‡è¯•æœºåˆ¶åº“ guava retrying


### æ‰¹é‡æ’å…¥

> [!NOTE] Title
> boolean result = this.saveBatch(questionBankQuestions);
> 


![[Pasted image 20251107151218.png]]![[Pasted image 20251107151829.png]]

## å¼‚æ­¥ä»»åŠ¡ä¼˜åŒ–

## æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–  Druid




### hotkey è‡ªåŠ¨ç¼“å­˜çƒ­é—¨é¢˜ç›®

https://gitee.com/jd-platform-opensource/hotkey
ä¸‹è½½etcd
https://github.com/etcd-io/etcd

ä½¿ç”¨ideaå¯åŠ¨hotkeyé¡¹ç›®æ•´ä½“æ‰“åŒ…æ„å»ºã€‚é…ç½®dashboard,åˆå§‹åŒ–æ•°æ®åº“ï¼Œç„¶åé…ç½®è‡ªå·±çš„è´¦å·å¯†ç 

ä¹‹åå®¢æˆ·ç«¯å¼•å…¥é¡¹ç›®é‡Œ
æ‰‹åŠ¨æºç æ‰“åŒ…å¼•å…¥
mavenè¿œç¨‹ä»“åº“

æ‰‹åŠ¨å°†clientçš„æ¨¡å—é€šè¿‡mavenæ‰“åŒ…æˆjar
```
# çƒ­key æ¢æµ‹  
hotkey:  
  appName: mianshihou  
  caffeineSize: 10000  
  pushPeriod: 1000  
  etcd-server: http://localhost:2379
```

---
```
/**  
 * çƒ­ key å‘ç°é…ç½®  
 *  
 * @author lora  
 * */@Configuration  
@ConfigurationProperties(prefix = "hotkey")  
@Data  
public class HotKeyConfig {  
  
    /**  
     * Etcd æœåŠ¡å™¨å®Œæ•´åœ°å€  
     */  
    private String etcdServer = "http://127.0.0.1:2379";  
  
    /**  
     * åº”ç”¨åç§°  
     */  
    private String appName = "app";  
  
    /**  
     * æœ¬åœ°ç¼“å­˜æœ€å¤§æ•°é‡  
     */  
    private int caffeineSize = 10000;  
  
    /**  
     * æ‰¹é‡æ¨é€ key çš„é—´éš”æ—¶é—´  
     */  
    private long pushPeriod = 1000L;  
  
    /**  
     * åˆå§‹åŒ– hotkey  
     */    @Bean  
    public void initHotkey() {  
        ClientStarter.Builder builder = new ClientStarter.Builder();  
        ClientStarter starter = builder.setAppName(appName)  
                .setCaffeineSize(caffeineSize)  
                .setPushPeriod(pushPeriod)  
                .setEtcdServer(etcdServer)  
                .build();  
        starter.startPipeline();  
    }  
}
```

å¯¹ä»»æ„çªå‘æ€§çš„æ— æ³•é¢„å…ˆæ„ŸçŸ¥çš„çƒ­ç‚¹æ•°æ®ï¼ŒåŒ…æ‹¬å¹¶ä¸é™äºçƒ­ç‚¹æ•°æ®ï¼ˆå¦‚çªå‘å¤§é‡è¯·æ±‚åŒä¸€ä¸ªå•†å“ï¼‰ã€çƒ­ç”¨æˆ·ï¼ˆå¦‚æ¶æ„çˆ¬è™«åˆ·å­ï¼‰ã€çƒ­æ¥å£ï¼ˆçªå‘æµ·é‡è¯·æ±‚åŒä¸€ä¸ªæ¥å£ï¼‰ç­‰ï¼Œè¿›è¡Œæ¯«ç§’çº§ç²¾å‡†æ¢æµ‹åˆ°ã€‚ç„¶åå¯¹è¿™äº›çƒ­æ•°æ®ã€çƒ­ç”¨æˆ·ç­‰ï¼Œæ¨é€åˆ°æ‰€æœ‰æœåŠ¡ç«¯JVMå†…å­˜ä¸­ï¼Œä»¥å¤§å¹…å‡è½»å¯¹åç«¯æ•°æ®å­˜å‚¨å±‚çš„å†²å‡»ï¼Œå¹¶å¯ä»¥ç”±ä½¿ç”¨è€…å†³å®šå¦‚ä½•åˆ†é…ã€ä½¿ç”¨è¿™äº›çƒ­keyï¼ˆè­¬å¦‚å¯¹çƒ­å•†å“åšæœ¬åœ°ç¼“å­˜ã€å¯¹çƒ­ç”¨æˆ·è¿›è¡Œæ‹’ç»è®¿é—®ã€å¯¹çƒ­æ¥å£è¿›è¡Œç†”æ–­æˆ–è¿”å›é»˜è®¤å€¼ï¼‰ã€‚è¿™äº›çƒ­æ•°æ®åœ¨æ•´ä¸ªæœåŠ¡ç«¯é›†ç¾¤å†…ä¿æŒä¸€è‡´æ€§ï¼Œå¹¶ä¸”ä¸šåŠ¡éš”ç¦»ï¼Œworkerç«¯æ€§èƒ½å¼ºæ‚ã€‚

äº¬ä¸œAPPåå°çƒ­æ•°æ®æ¢æµ‹æ¡†æ¶ï¼Œå†ç»å¤šæ¬¡é«˜å‹å‹æµ‹å’Œ2020å¹´äº¬ä¸œ618ã€åŒ11å¤§ä¿ƒè€ƒéªŒã€‚

åœ¨ä¸Šçº¿è¿è¡Œçš„è¿™æ®µæ—¶é—´å†…ï¼Œæ¯å¤©æ¢æµ‹çš„keyæ•°é‡æ•°åäº¿è®¡ï¼Œç²¾å‡†æ•è·äº†å¤§é‡çˆ¬è™«ã€åˆ·å­ç”¨æˆ·ï¼Œå¦å‡†ç¡®æ¢æµ‹å¤§é‡çƒ­é—¨å•†å“å¹¶æ¯«ç§’çº§æ¨é€åˆ°å„ä¸ªæœåŠ¡ç«¯å†…å­˜ï¼Œå¤§å¹…é™ä½äº†çƒ­æ•°æ®å¯¹æ•°æ®å±‚çš„æŸ¥è¯¢å‹åŠ›ï¼Œæå‡äº†åº”ç”¨æ€§èƒ½ã€‚

åœ¨å¤§ä¿ƒæœŸé—´ï¼Œhotkeyçš„workeré›†ç¾¤ç§’çº§ååé‡è¾¾åˆ°1500ä¸‡çº§åˆ«ï¼Œç”±hotkeyæ¢æµ‹å‡ºçš„çƒ­keyè¿›è€Œäº§ç”Ÿçš„æœ¬åœ°ç¼“å­˜å åº”ç”¨æ€»è®¿é—®é‡çš„50%ä»¥ä¸Šï¼Œä½¿å¾—å¤§éƒ¨åˆ†è¯·æ±‚è¿›è¡Œçš„æ˜¯æœ¬åœ°æŸ¥è¯¢ï¼Œå‡è½»äº†rediså±‚ä¸€åŠä»¥ä¸Šè´Ÿæ‹…ã€‚

è¯¥æ¡†æ¶å†ç»å¤šæ¬¡å‹æµ‹ï¼Œæ€§èƒ½æŒ‡æ ‡ä¸»è¦æœ‰ä¸¤ä¸ªï¼š

1 æ¢æµ‹æ€§èƒ½ï¼š8æ ¸å•æœºworkerç«¯æ¯ç§’å¯æ¥æ”¶å¤„ç†16ä¸‡ä¸ªkeyæ¢æµ‹ä»»åŠ¡ï¼Œ16æ ¸å•æœºè‡³å°‘æ¯ç§’å¹³ç¨³å¤„ç†30ä¸‡ä»¥ä¸Šï¼Œå®é™…å‹æµ‹è¾¾åˆ°37ä¸‡ï¼ŒCPUå¹³ç¨³æ”¯æ’‘ï¼Œæ¡†æ¶æ— å¼‚å¸¸ã€‚

2 æ¨é€æ€§èƒ½ï¼šåœ¨é«˜å¹¶å‘å†™å…¥çš„åŒæ—¶ï¼Œå¯¹å¤–æ¨é€ç›®å‰æ€§èƒ½çº¦å¹³ç¨³æ¨é€æ¯ç§’10-12ä¸‡æ¬¡ï¼Œè­¬å¦‚æœ‰1åƒå°serverï¼Œä¸€å°workerä¸Šæ¯ç§’äº§ç”Ÿäº†100ä¸ªçƒ­keyï¼Œé‚£ä¹ˆè¿™1ç§’ä¼šå¹³ç¨³æ¨é€100 * 1000 = 10ä¸‡æ¬¡ï¼Œ10ä¸‡æ¬¡æ¨é€ä¼šæ˜ç¡®åœ¨1så†…å…¨éƒ¨é€è¾¾ã€‚å¦‚æœæ˜¯å†™å…¥å°‘ï¼Œæ¨é€å¤šï¼Œä»¥çº¯æ¨é€æ¥è®¡æ•°çš„è¯ï¼Œè¯¥æ¡†æ¶æ¯ç§’å¯ç¨³å®šå¯¹å¤–æ¨é€40-60ä¸‡æ¬¡å¹³ç¨³ï¼Œ80ä¸‡æ¬¡æé™å¯æ’‘å‡ ç§’ã€‚

æ¯ç§’å•æœºååé‡ï¼ˆå†™å…¥+å¯¹å¤–æ¨é€ï¼‰ç›®å‰åœ¨70ä¸‡å·¦å³ç¨³å®šã€‚

åœ¨çœŸå®ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå¯ç”¨1ï¼š1000çš„æ¯”ä¾‹ï¼Œå³1å°workeræ”¯æ’‘1000å°ä¸šåŠ¡æœåŠ¡ç«¯çš„keyæ¢æµ‹ä»»åŠ¡ï¼Œå³å¯å¸¦æ¥æå¤§çš„æ•°æ®å­˜å‚¨èµ„æºèŠ‚çœï¼ˆå¦‚å¯¹redisé›†ç¾¤çš„æ‰©å……ï¼‰ã€‚æµ‹è¯•è¯¦æƒ…å¯å»æˆ‘[CSDNåšå®¢](https://gitee.com/link?target=https%3A%2F%2Fblog.csdn.net%2Ftianyaleixiaowu)æŸ¥çœ‹ã€‚

ä»»æ„çªå‘æ€§çš„æ— æ³•é¢„å…ˆæ„ŸçŸ¥çš„çƒ­ç‚¹è¯·æ±‚ï¼ŒåŒ…æ‹¬å¹¶ä¸é™äºçƒ­ç‚¹æ•°æ®ï¼ˆå¦‚çªå‘å¤§é‡è¯·æ±‚åŒä¸€ä¸ªå•†å“ï¼‰ã€çƒ­ç”¨æˆ·ï¼ˆå¦‚çˆ¬è™«ã€åˆ·å­ï¼‰ã€çƒ­æ¥å£ï¼ˆçªå‘æµ·é‡è¯·æ±‚åŒä¸€ä¸ªæ¥å£ï¼‰ç­‰ï¼Œè¿›è¡Œæ¯«ç§’çº§ç²¾å‡†æ¢æµ‹åˆ°ã€‚ ç„¶åå¯¹è¿™äº›çƒ­æ•°æ®ã€çƒ­ç”¨æˆ·ç­‰ï¼Œæ¨é€åˆ°è¯¥åº”ç”¨éƒ¨ç½²çš„æ‰€æœ‰æœºå™¨JVMå†…å­˜ä¸­ï¼Œä»¥å¤§å¹…å‡è½»å¯¹åç«¯æ•°æ®å­˜å‚¨å±‚çš„å†²å‡»ï¼Œå¹¶å¯ä»¥ç”±å®¢æˆ·ç«¯å†³å®šå¦‚ä½•ä½¿ç”¨è¿™äº›çƒ­keyï¼ˆè­¬å¦‚å¯¹çƒ­å•†å“åšæœ¬åœ°ç¼“å­˜ã€å¯¹çƒ­ç”¨æˆ·è¿›è¡Œæ‹’ç»è®¿é—®ã€å¯¹çƒ­æ¥å£è¿›è¡Œç†”æ–­æˆ–è¿”å›é»˜è®¤å€¼ï¼‰ã€‚ è¿™äº›çƒ­keyåœ¨æ•´ä¸ªåº”ç”¨é›†ç¾¤å†…ä¿æŒä¸€è‡´æ€§ã€‚

æ ¸å¿ƒåŠŸèƒ½ï¼šçƒ­æ•°æ®æ¢æµ‹å¹¶æ¨é€è‡³é›†ç¾¤å„ä¸ªæœåŠ¡å™¨

é€‚ç”¨åœºæ™¯ï¼š

1 mysqlçƒ­æ•°æ®æœ¬åœ°ç¼“å­˜

2 redisçƒ­æ•°æ®æœ¬åœ°ç¼“å­˜

3 é»‘åå•ç”¨æˆ·æœ¬åœ°ç¼“å­˜

4 çˆ¬è™«ç”¨æˆ·é™æµ

5 æ¥å£ã€ç”¨æˆ·ç»´åº¦é™æµ

6 å•æœºæ¥å£ã€ç”¨æˆ·ç»´åº¦é™æµ

7 é›†ç¾¤ç”¨æˆ·ç»´åº¦é™æµ

8 é›†ç¾¤æ¥å£ç»´åº¦é™æµ

etcdServerä¸ºetcdé›†ç¾¤çš„åœ°å€ï¼Œç”¨é€—å·åˆ†éš”

JAVA_OPTSæ˜¯é…ç½®çš„JVMç›¸å…³ï¼Œå¯æ ¹æ®å®é™…æƒ…å†µé…ç½®

threadCountä¸ºå¤„ç†keyçš„çº¿ç¨‹æ•°ï¼Œä¸æŒ‡å®šæ—¶ç”±ç¨‹åºæ¥è®¡ç®—ã€‚

workerPathä»£è¡¨è¯¥workerä¸ºå“ªä¸ªåº”ç”¨æä¾›è®¡ç®—æœåŠ¡ï¼Œè­¬å¦‚ä¸åŒçš„åº”ç”¨appNameéœ€è¦ç”¨ä¸åŒçš„workerè¿›è¡Œéš”ç¦»ï¼Œä»¥é¿å…èµ„æºç«äº‰ã€‚

æœåŸæœ‰é¡¹ç›®ä½¿ç”¨äº†fastjsonï¼Œéœ€è¦é™ä¸º`2.0.0`ç‰ˆæœ¬ä»¥ä¸‹ï¼Œ åœ¨`2.0.0`ç‰ˆæœ¬ä»¥ä¸Šï¼Œ`com.alibaba.fastjson.serializer.JSONLibDataFormatSerializer`ç±»å·²ç»åˆ é™¤ã€‚ å¯¼è‡´JSONå·¥å…·ç±»`com.jd.platform.hotkey.common.tool.FastJsonUtils`åˆå§‹åŒ–æ—¶æ‰¾ä¸åˆ°ç±»ã€‚ è§„åˆ™é…ç½®çš„jsonè½¬æ¢æœ‰é—®é¢˜ã€‚ æ¨èä½¿ç”¨ä¸HotKeyç›¸åŒçš„ç‰ˆæœ¬ï¼š

```
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>fastjson</artifactId>
    <version>1.2.70</version>
</dependency>
```

ä½¿ç”¨ï¼š

ä¸»è¦æœ‰å¦‚ä¸‹4ä¸ªæ–¹æ³•å¯ä¾›ä½¿ç”¨

boolean JdHotKeyStore.isHotKey(String key)

Object JdHotKeyStore.get(String key)

void JdHotKeyStore.smartSet(String key, Object value)

Object JdHotKeyStore.getValue(String key)

1 boolean isHotKey(String key) ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›è¯¥keyæ˜¯å¦æ˜¯çƒ­keyï¼Œå¦‚æœæ˜¯è¿”å›trueï¼Œå¦‚æœä¸æ˜¯è¿”å›falseï¼Œå¹¶ä¸”ä¼šå°†keyä¸ŠæŠ¥åˆ°æ¢æµ‹é›†ç¾¤è¿›è¡Œæ•°é‡è®¡ç®—ã€‚è¯¥æ–¹æ³•é€šå¸¸ç”¨äºåˆ¤æ–­åªéœ€è¦åˆ¤æ–­keyæ˜¯å¦çƒ­ã€ä¸éœ€è¦ç¼“å­˜valueçš„åœºæ™¯ï¼Œå¦‚åˆ·å­ç”¨æˆ·ã€æ¥å£è®¿é—®é¢‘ç‡ç­‰ã€‚

2 Object get(String key)ï¼Œè¯¥æ–¹æ³•è¿”å›è¯¥keyæœ¬åœ°ç¼“å­˜çš„valueå€¼ï¼Œå¯ç”¨äºåˆ¤æ–­æ˜¯çƒ­keyåï¼Œå†å»è·å–æœ¬åœ°ç¼“å­˜çš„valueå€¼ï¼Œé€šå¸¸ç”¨äºredisçƒ­keyç¼“å­˜

3 void smartSet(String key, Object value)ï¼Œæ–¹æ³•ç»™çƒ­keyèµ‹å€¼valueï¼Œå¦‚æœæ˜¯çƒ­keyï¼Œè¯¥æ–¹æ³•æ‰ä¼šèµ‹å€¼ï¼Œéçƒ­keyï¼Œä»€ä¹ˆä¹Ÿä¸åš

4 Object getValue(String key)ï¼Œè¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªæ•´åˆæ–¹æ³•ï¼Œç›¸å½“äºisHotKeyå’Œgetä¸¤ä¸ªæ–¹æ³•çš„æ•´åˆï¼Œè¯¥æ–¹æ³•ç›´æ¥è¿”å›æœ¬åœ°ç¼“å­˜çš„valueã€‚ å¦‚æœæ˜¯çƒ­keyï¼Œåˆ™å­˜åœ¨ä¸¤ç§æƒ…å†µï¼Œ1æ˜¯è¿”å›valueï¼Œ2æ˜¯è¿”å›nullã€‚è¿”å›nullæ˜¯å› ä¸ºå°šæœªç»™å®ƒsetçœŸæ­£çš„valueï¼Œè¿”å›énullè¯´æ˜å·²ç»è°ƒç”¨è¿‡setæ–¹æ³•äº†ï¼Œæœ¬åœ°ç¼“å­˜valueæœ‰å€¼äº†ã€‚ å¦‚æœä¸æ˜¯çƒ­keyï¼Œåˆ™è¿”å›nullï¼Œå¹¶ä¸”å°†keyä¸ŠæŠ¥åˆ°æ¢æµ‹é›†ç¾¤è¿›è¡Œæ•°é‡æ¢æµ‹ã€‚

æœ€ä½³å®è·µï¼š

1 åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ˜¯åˆ·å­

```
    if (JdHotKeyStore.isHotKey(â€œpin__â€ + thePin)) {
        //é™æµä»–ï¼Œdo your job
    } 
```

2 åˆ¤æ–­å•†å“idæ˜¯å¦æ˜¯çƒ­ç‚¹

```
       Object skuInfo = JdHotKeyStore.getValue("skuId__" + skuId);
       if(skuInfo == null) {
           JdHotKeyStore.smartSet("skuId__" + skuId, theSkuInfo);
       } else {
              //ä½¿ç”¨ç¼“å­˜å¥½çš„valueå³å¯
        }
```

æˆ–è€…è¿™æ ·ï¼š

```
         if (JdHotKeyStore.isHotKey(key)) {
              //æ³¨æ„æ˜¯getï¼Œä¸æ˜¯getValueã€‚getValueä¼šè·å–å¹¶ä¸ŠæŠ¥ï¼Œgetæ˜¯çº¯ç²¹çš„æœ¬åœ°è·å–
              Object skuInfo = JdHotKeyStore.get("skuId__" + skuId);
              if(skuInfo == null) {
                  JdHotKeyStore.smartSet("skuId__" + skuId, theSkuInfo);
              } else {
                  //ä½¿ç”¨ç¼“å­˜å¥½çš„valueå³å¯
              }

         }
```
![[Pasted image 20251108151607.png]]
![[Pasted image 20251108151617.png]]

![[Pasted image 20251108151816.png]]

å¥½çš„ï¼Œæˆ‘ä»¬æ¥è¯¦ç»†èŠèŠ **ç¼“å­˜é›ªå´©** è¿™ä¸ªåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éå¸¸è‡´å‘½çš„é—®é¢˜ã€‚

### ğŸ¤” ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©ï¼Ÿ

**ç¼“å­˜é›ªå´©** æ˜¯æŒ‡åœ¨æŸä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œ**å¤§é‡ç¼“å­˜æ•°æ®åŒæ—¶å¤±æ•ˆ**ï¼ˆæˆ–ç¼“å­˜æœåŠ¡æ•´ä½“å®•æœºï¼‰ï¼Œå¯¼è‡´æ‰€æœ‰è¯·æ±‚éƒ½æ¶Œå‘æ•°æ®åº“ï¼Œé€ æˆæ•°æ®åº“ç¬æ—¶å‹åŠ›è¿‡å¤§è€Œå´©æºƒï¼Œè¿›è€Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿç˜«ç—ªçš„ç°è±¡ã€‚

**ç®€å•æ¯”å–»**ï¼šå°±åƒèŠ‚å‡æ—¥é«˜é€Ÿå…¬è·¯æ”¶è´¹ç«™ï¼Œæ‰€æœ‰æ”¶è´¹å£åŒæ—¶å…³é—­ï¼Œå¯¼è‡´æ‰€æœ‰è½¦è¾†éƒ½å µåœ¨ä¸€æ¡å°è·¯ä¸Šï¼Œæœ€ç»ˆé€ æˆæ•´ä¸ªäº¤é€šç³»ç»Ÿç˜«ç—ªã€‚

---

### ğŸ¯ ç¼“å­˜é›ªå´© vs ç¼“å­˜å‡»ç©¿ vs ç¼“å­˜ç©¿é€

ä¸ºäº†æ›´å¥½ç†è§£ï¼Œæˆ‘ä»¬å…ˆåŒºåˆ†è¿™ä¸‰ä¸ªç›¸ä¼¼æ¦‚å¿µï¼š

| ç°è±¡       | æ ¸å¿ƒé—®é¢˜                          | å½±å“èŒƒå›´           |
| :------- | :---------------------------- | :------------- |
| **ç¼“å­˜é›ªå´©** | **å¤§é‡keyåŒæ—¶å¤±æ•ˆ** æˆ– **RedisæœåŠ¡å®•æœº** | ç³»ç»Ÿçº§ç¾éš¾ï¼Œæ•´ä¸ªç³»ç»Ÿå¯èƒ½ç˜«ç—ª |
| **ç¼“å­˜å‡»ç©¿** | **å•ä¸ªçƒ­ç‚¹keyå¤±æ•ˆ**ï¼Œå¤§é‡å¹¶å‘è¯·æ±‚è¿™ä¸ªkey     | å½±å“å•ä¸ªkeyçš„ç›¸å…³åŠŸèƒ½   |
| **ç¼“å­˜ç©¿é€** | æŸ¥è¯¢**æ•°æ®åº“ä¸­æ ¹æœ¬ä¸å­˜åœ¨**çš„æ•°æ®            | æ¶ˆè€—èµ„æºï¼Œä½†é€šå¸¸æœ‰ä¸Šé™    |

---

### ğŸ’¥ ç¼“å­˜é›ªå´©çš„ä¸¤ç§ä¸»è¦åœºæ™¯

#### åœºæ™¯1ï¼šå¤§é‡KeyåŒæ—¶è¿‡æœŸ

è¿™æ˜¯æœ€å¸¸è§çš„é›ªå´©åœºæ™¯ã€‚

**é—®é¢˜ä»£ç ç¤ºä¾‹**ï¼š
```java
// é”™è¯¯çš„åšæ³•ï¼šæ‰¹é‡åˆå§‹åŒ–ç¼“å­˜ï¼Œè®¾ç½®ç›¸åŒçš„è¿‡æœŸæ—¶é—´
public void initCache() {
    List<Product> products = productMapper.selectAll();
    for (Product product : products) {
        // æ‰€æœ‰keyéƒ½è®¾ç½®30åˆ†é’Ÿè¿‡æœŸ
        String key = "product:" + product.getId();
        redisTemplate.opsForValue().set(key, product, 30, TimeUnit.MINUTES);
    }
}
```

**åæœ**ï¼š30åˆ†é’Ÿåï¼Œæ‰€æœ‰å•†å“ç¼“å­˜åŒæ—¶å¤±æ•ˆï¼Œå¤§é‡å•†å“è¯¦æƒ…é¡µè¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚

#### åœºæ™¯2ï¼šRedisæœåŠ¡å®•æœº

- Redisé›†ç¾¤æ•´ä½“ä¸å¯ç”¨
- ç½‘ç»œåˆ†åŒºå¯¼è‡´åº”ç”¨æ— æ³•è¿æ¥Redis
- æœºæˆ¿æ•…éšœç­‰åŸºç¡€è®¾æ–½é—®é¢˜

---

### ğŸ›¡ï¸ è§£å†³æ–¹æ¡ˆä¸å®æˆ˜ä»£ç 

#### æ–¹æ¡ˆ1ï¼šè®¾ç½®éšæœºè¿‡æœŸæ—¶é—´ï¼ˆæ²»æ ‡ï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šè®©keyçš„è¿‡æœŸæ—¶é—´åˆ†æ•£å¼€ï¼Œé¿å…åŒæ—¶å¤±æ•ˆã€‚

```java
@Service
public class ProductService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * è®¾ç½®ç¼“å­˜ - æ·»åŠ éšæœºè¿‡æœŸæ—¶é—´
     */
    public void setProductCache(Product product) {
        String key = "product:" + product.getId();
        
        // åŸºç¡€è¿‡æœŸæ—¶é—´ + éšæœºæ—¶é—´ï¼ˆ0-300ç§’ï¼‰
        long baseTimeout = 30 * 60; // 30åˆ†é’Ÿ
        long randomTimeout = ThreadLocalRandom.current().nextInt(0, 300);
        long totalTimeout = baseTimeout + randomTimeout;
        
        redisTemplate.opsForValue().set(
            key, 
            product, 
            totalTimeout, 
            TimeUnit.SECONDS
        );
        
        System.out.println("Key: " + key + " è¿‡æœŸæ—¶é—´: " + totalTimeout + "ç§’");
    }
    
    /**
     * æ‰¹é‡åˆå§‹åŒ–ç¼“å­˜ - å®‰å…¨ç‰ˆæœ¬
     */
    public void initCacheSafely() {
        List<Product> products = productMapper.selectAll();
        for (Product product : products) {
            setProductCache(product);
        }
    }
}
```

#### æ–¹æ¡ˆ2ï¼šæ°¸ä¸è¿‡æœŸ + ä¸»åŠ¨æ›´æ–°ï¼ˆæ²»æœ¬ï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šç¼“å­˜æ°¸ä¸è¿‡æœŸï¼Œé€šè¿‡åå°ä»»åŠ¡æˆ–æ¶ˆæ¯é˜Ÿåˆ—ä¸»åŠ¨æ›´æ–°ã€‚

```java
@Service
public class ProductService {
    
    /**
     * è®¾ç½®æ°¸ä¸è¿‡æœŸç¼“å­˜
     */
    public void setProductCacheForever(Product product) {
        String key = "product:" + product.getId();
        redisTemplate.opsForValue().set(key, product);
        // ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæ°¸ä¹…æœ‰æ•ˆ
    }
    
    /**
     * åå°å®šæ—¶æ›´æ–°ç¼“å­˜
     */
    @Scheduled(fixedRate = 20 * 60 * 1000) // æ¯20åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void refreshProductCache() {
        System.out.println("å¼€å§‹å®šæ—¶åˆ·æ–°å•†å“ç¼“å­˜...");
        List<Product> products = productMapper.selectAll();
        for (Product product : products) {
            setProductCacheForever(product);
        }
    }
    
    /**
     * é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æ›´æ–°å•ä¸ªå•†å“ç¼“å­˜
     */
    @EventListener
    public void updateProductCache(ProductUpdateEvent event) {
        String key = "product:" + event.getProductId();
        Product latestProduct = productMapper.selectById(event.getProductId());
        if (latestProduct != null) {
            redisTemplate.opsForValue().set(key, latestProduct);
        }
    }
}
```

#### æ–¹æ¡ˆ3ï¼šå¤šçº§ç¼“å­˜æ¶æ„

**æ ¸å¿ƒæ€æƒ³**ï¼šå»ºç«‹å¤šçº§ç¼“å­˜ï¼Œå½“Rediså¤±æ•ˆæ—¶ï¼Œè¿˜æœ‰æœ¬åœ°ç¼“å­˜å…œåº•ã€‚

```java
@Service
public class ProductService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // æœ¬åœ°ç¼“å­˜ï¼ˆä½¿ç”¨Caffeineï¼‰
    private Cache<String, Product> localCache = Caffeine.newBuilder()
        .expireAfterWrite(10, TimeUnit.MINUTES) // 10åˆ†é’Ÿè¿‡æœŸ
        .maximumSize(1000)
        .build();
    
    /**
     * å¤šçº§ç¼“å­˜æŸ¥è¯¢
     */
    public Product getProductWithMultiCache(Long productId) {
        String key = "product:" + productId;
        
        // 1. æŸ¥è¯¢æœ¬åœ°ç¼“å­˜
        Product product = localCache.getIfPresent(key);
        if (product != null) {
            System.out.println("å‘½ä¸­æœ¬åœ°ç¼“å­˜");
            return product;
        }
        
        // 2. æŸ¥è¯¢Redisç¼“å­˜
        product = (Product) redisTemplate.opsForValue().get(key);
        if (product != null) {
            System.out.println("å‘½ä¸­Redisç¼“å­˜ï¼Œå›å¡«æœ¬åœ°ç¼“å­˜");
            localCache.put(key, product);
            return product;
        }
        
        // 3. æŸ¥è¯¢æ•°æ®åº“
        System.out.println("ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“");
        product = productMapper.selectById(productId);
        if (product != null) {
            // å¼‚æ­¥å›å¡«ç¼“å­˜
            CompletableFuture.runAsync(() -> {
                redisTemplate.opsForValue().set(key, product, 30, TimeUnit.MINUTES);
                localCache.put(key, product);
            });
        }
        
        return product;
    }
}
```

#### æ–¹æ¡ˆ4ï¼šç†”æ–­é™çº§æœºåˆ¶

**æ ¸å¿ƒæ€æƒ³**ï¼šå½“æ£€æµ‹åˆ°æ•°æ®åº“å‹åŠ›è¿‡å¤§æ—¶ï¼Œä¸»åŠ¨æ‹’ç»éƒ¨åˆ†è¯·æ±‚ï¼Œä¿æŠ¤æ•°æ®åº“ã€‚

```java
@Service
public class ProductService {
    
    // ä½¿ç”¨Hystrixæˆ–Resilience4jå®ç°ç†”æ–­
    @HystrixCommand(fallbackMethod = "getProductFallback")
    public Product getProductWithCircuitBreaker(Long productId) {
        return getProductWithMultiCache(productId);
    }
    
    /**
     * é™çº§æ–¹æ³•
     */
    public Product getProductFallback(Long productId) {
        // è¿”å›é»˜è®¤å•†å“ã€ç¼“å­˜ä¸­çš„æ—§æ•°æ®ã€æˆ–è€…å‹å¥½æç¤º
        return createDefaultProduct();
    }
    
    private Product createDefaultProduct() {
        Product product = new Product();
        product.setId(0L);
        product.setName("æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•");
        return product;
    }
}
```

#### æ–¹æ¡ˆ5ï¼šç¼“å­˜é¢„çƒ­ä¸é›†ç¾¤é«˜å¯ç”¨

**ç¼“å­˜é¢„çƒ­**ï¼š
```java
@Component
public class CacheWarmUp implements ApplicationRunner {
    
    @Autowired
    private ProductService productService;
    
    /**
     * åº”ç”¨å¯åŠ¨æ—¶é¢„çƒ­ç¼“å­˜
     */
    @Override
    public void run(ApplicationArguments args) {
        System.out.println("å¼€å§‹ç¼“å­˜é¢„çƒ­...");
        productService.initCacheSafely();
        System.out.println("ç¼“å­˜é¢„çƒ­å®Œæˆ");
    }
}
```

**Redisé›†ç¾¤é«˜å¯ç”¨**ï¼š
- ä½¿ç”¨ Redis Cluster æ¨¡å¼ï¼Œæ•°æ®åˆ†ç‰‡å­˜å‚¨
- ä½¿ç”¨ Redis Sentinel æ¨¡å¼ï¼Œä¸»ä»è‡ªåŠ¨æ•…éšœè½¬ç§»
- å¤šæœºæˆ¿éƒ¨ç½²ï¼Œå¼‚åœ°å®¹ç¾

---

### ğŸ“‹ å®Œæ•´çš„é˜²å¾¡æ–¹æ¡ˆ

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œåº”è¯¥é‡‡ç”¨**ç»„åˆæ–¹æ¡ˆ**ï¼š

```java
@Service
public class SafeProductService {
    
    // 1. å¤šçº§ç¼“å­˜
    private Cache<String, Product> localCache = Caffeine.newBuilder().build();
    
    // 2. è·å–å•†å“ - ç»¼åˆæ–¹æ¡ˆ
    public Product getProductSafely(Long productId) {
        String key = "product:" + productId;
        
        // ç¬¬ä¸€å±‚ï¼šæœ¬åœ°ç¼“å­˜
        Product product = localCache.getIfPresent(key);
        if (product != null) return product;
        
        // ç¬¬äºŒå±‚ï¼šRedisç¼“å­˜ï¼ˆéšæœºè¿‡æœŸæ—¶é—´ï¼‰
        product = (Product) redisTemplate.opsForValue().get(key);
        if (product != null) {
            localCache.put(key, product);
            return product;
        }
        
        // ç¬¬ä¸‰å±‚ï¼šæ•°æ®åº“æŸ¥è¯¢ + ç†”æ–­ä¿æŠ¤
        return getFromDBWithProtection(productId, key);
    }
    
    // 3. æ•°æ®åº“æŸ¥è¯¢ä¿æŠ¤
    private Product getFromDBWithProtection(Long productId, String key) {
        try {
            Product product = productMapper.selectById(productId);
            if (product != null) {
                // å¼‚æ­¥å›å¡«ï¼Œè®¾ç½®éšæœºè¿‡æœŸæ—¶é—´
                CompletableFuture.runAsync(() -> {
                    setProductCacheRandom(key, product);
                });
            }
            return product;
        } catch (Exception e) {
            // æ•°æ®åº“å¼‚å¸¸æ—¶ï¼Œè¿”å›é™çº§æ•°æ®
            log.error("æ•°æ®åº“æŸ¥è¯¢å¼‚å¸¸ï¼Œè§¦å‘é™çº§", e);
            return createDegradeProduct();
        }
    }
    
    // 4. è®¾ç½®éšæœºè¿‡æœŸæ—¶é—´
    private void setProductCacheRandom(String key, Product product) {
        long timeout = 30 * 60 + ThreadLocalRandom.current().nextInt(0, 300);
        redisTemplate.opsForValue().set(key, product, timeout, TimeUnit.SECONDS);
        localCache.put(key, product);
    }
}
```

---

### ğŸ’¡ æ€»ç»“

é˜²å¾¡ç¼“å­˜é›ªå´©çš„å…³é”®ç­–ç•¥ï¼š

1. **âœ… éšæœºè¿‡æœŸæ—¶é—´** - é¿å…å¤§é‡keyåŒæ—¶å¤±æ•ˆ
2. **âœ… æ°¸ä¸è¿‡æœŸ + ä¸»åŠ¨æ›´æ–°** - ä»æ ¹æœ¬ä¸Šè§£å†³è¿‡æœŸé—®é¢˜  
3. **âœ… å¤šçº§ç¼“å­˜** - å»ºç«‹ç¼“å­˜é˜²çº¿
4. **âœ… ç†”æ–­é™çº§** - ä¿æŠ¤æ•°æ®åº“ä¸è¢«å‹å®
5. **âœ… ç¼“å­˜é¢„çƒ­** - ç³»ç»Ÿå¯åŠ¨æ—¶æå‰åŠ è½½
6. **âœ… é›†ç¾¤é«˜å¯ç”¨** - é˜²æ­¢å•ç‚¹æ•…éšœ

**æœ€é‡è¦çš„åŸåˆ™**ï¼šæ°¸è¿œä¸è¦è®©æ‰€æœ‰å‹åŠ›åŒæ—¶é›†ä¸­åˆ°æ•°æ®åº“ï¼


### æµé‡æ§åˆ¶
## é™æµå’Œæ’é˜Ÿ

![[Pasted image 20251108173225.png]]
```

java "-Dserver.port=8131" -jar sentinel-dashboard-1.8.6.jar
```

```
    <dependency>  
    <groupId>com.alibaba.csp</groupId>  
    <artifactId>sentinel-transport-simple-http</artifactId>  
    <version>1.8.6</version>  
</dependency>
```

ç¨‹åºå¯åŠ¨æ—¶éœ€è¦åŠ å…¥ JVM å‚æ•° -Dcsp.sentinel.dashboard.server=consoleIp:port æŒ‡å®š æ§åˆ¶å°åœ°å€å’Œç«¯å£ã€‚è‹¥å¯åŠ¨å¤šä¸ªåº”ç”¨ï¼Œåˆ™éœ€è¦é€šè¿‡ -Dcsp.sentinel.api.port=xxxx æŒ‡å®šå®¢æˆ· ç«¯ç›‘æ§ API çš„ç«¯å£ï¼ˆé»˜è®¤æ˜¯ 8719ï¼‰



åŸºäº Spring Boot Starter + æ³¨è§£æ¨¡å¼å¼€å‘ + åŸå§‹è§„åˆ™æ¨é€æ¨¡å¼å¼€å‘ 6ã€æ•´åˆ Spring Boot 16656å­— Spring Boot é¡¹ç›®å¯ä»¥è½»æ¾å’Œ Sentinel é›†æˆï¼Œç›´æ¥å¼•å…¥ä¸€ä¸ª starterï¼Œä½¿ç”¨ Spring Cloud Alibaba Sentinel å³å¯ã€‚ åœ¨å¼•å…¥æ•´åˆä¾èµ–æ—¶ï¼Œä¸€å®šè¦æ³¨æ„ç‰ˆæœ¬å·ï¼ å»ºè®® å‚è€ƒå®˜æ–¹æ–‡æ¡£é€‰æ‹©ç‰ˆæœ¬ ã€‚ç”±äº Spring Boot 3.0ï¼ŒSpring Boot 2.7~2.4 å’Œ 2.4 ä»¥ä¸‹ç‰ˆæœ¬ä¹‹é—´å˜åŒ–è¾ƒå¤§ï¼Œç›®å‰ä¼ä¸šçº§å®¢ æˆ·è€é¡¹ç›®ç›¸å…³ Spring Boot ç‰ˆæœ¬ä»åœç•™åœ¨ Spring Boot 2.4 ä»¥ä¸‹ï¼Œä¸ºäº†åŒæ—¶æ»¡è¶³å­˜é‡ç”¨æˆ·å’Œæ–°ç”¨æˆ· ä¸åŒéœ€æ±‚ï¼Œç¤¾åŒºä»¥ Spring Boot 3.0 å’Œ 2.4 åˆ†åˆ«ä¸ºåˆ†ç•Œçº¿ï¼ŒåŒæ—¶ç»´æŠ¤ 2022.xã€2021.xã€2.2.x ä¸‰ä¸ª

```
<!-- https://mvnrepository.com/artifact/com.alibaba.cloud/spring-cloud-starte-->  
<dependency>  
    <groupId>com.alibaba.cloud</groupId>  
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>  
    <version>2021.0.5.0</version>  
</dependency>
```




# æµæ§å’Œé™æµç†”æ–­é…ç½®è§„åˆ™

```
package com.lora.mianshihou.sentinel;  
  
import com.alibaba.csp.sentinel.slots.block.degrade.DegradeRule;  
import com.alibaba.csp.sentinel.slots.block.degrade.DegradeRuleManager;  
import com.alibaba.csp.sentinel.slots.block.degrade.circuitbreaker.CircuitBreakerStrategy;  
import com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowRule;  
import com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowRuleManager;  
import org.springframework.stereotype.Component;  
  
import javax.annotation.PostConstruct;  
import java.util.Arrays;  
import java.util.Collections;  
  
  
/**  
 * sentinel é™æµæ§åˆ¶ç®¡ç†å™¨  
 *  
 */  
@Component  
public class SentinelRulesManager {  
    //æ‰§è¡Œä¸€æ¬¡  
    @PostConstruct  
    public void init() {  
        initFlowRules();  
        initDegradeRules();  
    }  
  
    // é™æµè§„åˆ™  
    public void initFlowRules() {  
        // å• IP æŸ¥çœ‹é¢˜ç›®åˆ—è¡¨é™æµè§„åˆ™  
        ParamFlowRule rule = new ParamFlowRule("listQuestionVOByPage")  
                .setParamIdx(0) // å¯¹ç¬¬ 0 ä¸ªå‚æ•°é™æµï¼Œå³ IP åœ°å€  
                .setCount(10) // æ¯åˆ†é’Ÿæœ€å¤š 60 æ¬¡  
                .setDurationInSec(60); // è§„åˆ™çš„ç»Ÿè®¡å‘¨æœŸä¸º 60 ç§’  
        ParamFlowRuleManager.loadRules(Collections.singletonList(rule));  
    }  
  
    // é™çº§è§„åˆ™  
    public void initDegradeRules() {  
        // å• IP æŸ¥çœ‹é¢˜ç›®åˆ—è¡¨ç†”æ–­è§„åˆ™  
        // æ…¢è°ƒç”¨æ¯”ä¾‹å¤§äº 20%        // ç†”æ–­æŒç»­æ—¶é—´ 60 ç§’  
        // ç»Ÿè®¡æ—¶é•¿ 30 ç§’  
// å• IP æŸ¥çœ‹é¢˜ç›®åˆ—è¡¨ç†”æ–­è§„åˆ™  
        DegradeRule slowCallRule; // å“åº”æ—¶é—´è¶…è¿‡ 3 ç§’  
        slowCallRule = new DegradeRule("listQuestionVOByPage")  
                .setGrade(CircuitBreakerStrategy.SLOW_REQUEST_RATIO.getType())  
                        .setCount(0.2) // æ…¢è°ƒç”¨æ¯”ä¾‹å¤§äº 20%                        .setTimeWindow(60) // ç†”æ–­æŒç»­æ—¶é—´ 60 ç§’  
                        .setStatIntervalMs(30 * 1000) // ç»Ÿè®¡æ—¶é•¿ 30 ç§’  
                        .setMinRequestAmount(10) // æœ€å°è¯·æ±‚æ•°  
                        .setSlowRatioThreshold(3); // å“åº”æ—¶é—´è¶…è¿‡ 3ç§’  
  
  
        DegradeRule errorRateRule = new DegradeRule("listQuestionVOByPage")  
                .setGrade(CircuitBreakerStrategy.ERROR_RATIO.getType())  
                .setCount(0.1) // å¼‚å¸¸ç‡å¤§äº 10%                .setTimeWindow(60) // ç†”æ–­æŒç»­æ—¶é—´ 60 ç§’  
                .setStatIntervalMs(30 * 1000) // ç»Ÿè®¡æ—¶é•¿ 30 ç§’  
                .setMinRequestAmount(10); // æœ€å°è¯·æ±‚æ•°  
        // åŠ è½½è§„åˆ™  
        DegradeRuleManager.loadRules(Arrays.asList(slowCallRule, errorRateRule));  
    }  
}
```


![[Pasted image 20251109163110.png]]

æ‰©å±•1ï¼š
![[Pasted image 20251111210516.png]]
![[Pasted image 20251111210548.png]]

![[Pasted image 20251111220358.png]]![[Pasted image 20251111220438.png]]
![[Pasted image 20251111220503.png]]
![[Pasted image 20251111220521.png]]

![[Pasted image 20251111220548.png]]
![[Pasted image 20251111220558.png]]

![[Pasted image 20251111220614.png]]

![[Pasted image 20251111220624.png]]


![[Pasted image 20251111220653.png]]



![[Pasted image 20251111220725.png]]

![[Pasted image 20251111220754.png]]
![[Pasted image 20251111220803.png]]


![[Pasted image 20251111220835.png]]

å‡çº§nextjs 14 åˆ°nextjs 16
  nextjs mcp


```
1.UPDATE question_bank qb
SET question_count = (
    SELECT COUNT(*)
    FROM question_bank_question qbq
    WHERE qbq.questionBankId = qb.id AND qbq.isDelete = 0
)
WHERE qb.id > 0;  -- åŠ ä¸€ä¸ªæ°¸è¿œä¸ºçœŸçš„æ¡ä»¶

```
```
UPDATE question_bank qb
JOIN (
    SELECT questionBankId, COUNT(*) AS cnt
    FROM question_bank_question
    WHERE isDelete = 0
    GROUP BY questionBankId
) AS sub ON sub.questionBankId = qb.id
SET qb.question_count = sub.cnt;

```

```
// ç¡®ä¿æ–¹æ³•ä¸Šæœ‰äº‹åŠ¡æ³¨è§£ï¼ˆå¦‚æœæ–¹æ³•ä¸­è¿˜æœ‰å…¶ä»– DB æ“ä½œï¼‰
@Transactional
public void incrementQuestionCount(List<QuestionBankQuestion> questionBankQuestions) {
    if (CollectionUtils.isEmpty(questionBankQuestions)) {
        return;
    }

    int add = questionBankQuestions.size();
    if (add <= 0) {
        return;
    }

    Long questionBankId = questionBankQuestions.get(0).getQuestionBankId();
    // ä½¿ç”¨åŸå­è‡ªå¢ï¼Œä¸è¦åŠ  FOR UPDATE
    boolean ok = questionBankService.update()
            .setSql("question_count = question_count + " + add)
            .eq("id", questionBankId)
            .update();

    if (!ok) {
        // æ ¹æ®ä¸šåŠ¡å†³å®šï¼šé‡è¯•ã€æŠ›å¼‚å¸¸æˆ–è®°å½•æ—¥å¿—
        log.warn("æ›´æ–° question_count å¤±è´¥, questionBankId={}, add={}", questionBankId, add);
    }
}

```

---
```/**  
 * æ‰¹é‡å¢åŠ é¢˜åº“é¢˜ç›®æ€»æ•°  
 *  
 * @param items é¢˜åº“é¢˜ç›®å…³è”åˆ—è¡¨  
 */  
@Override  
public void batchIncrementQuestionCounts(List<QuestionBankQuestion> items) {  
    if (CollUtil.isEmpty(items)) {  
        return;  
    }  
    // èšåˆæ¯ä¸ªé¢˜åº“çš„questionBankIdçš„å¢é‡  
    Map<Long, Integer> counts = items.stream()  
            .collect(Collectors.groupingBy(  
                    QuestionBankQuestion::getQuestionBankId,  
                    Collectors.summingInt(e -> 1)  
                    //ä½œç”¨ç›¸å½“äº COUNT(*) â€”â€” æ¯ä¸ªç›¸åŒ questionBankId çš„å…ƒç´ åŠ  1            ));  
    // é€ä¸ªæ‰§è¡Œé€’å¢  
  
    counts.forEach((bankId, cnt) -> {  
        if (bankId != null && cnt != null && cnt > 0) {  
            boolean ok = questionBankService.update()  
                    .setSql("question_count=question_count+" + cnt)  
                    .eq("id", bankId)  
                    .update();  
            if (!ok) {  
                ThrowUtils.throwIf(ok == false, ErrorCode.OPERATION_ERROR, "æ‰¹é‡æ›´æ–°é¢˜åº“ä¸­é¢˜ç›®æ€»æ•°");  
            }  
        }  
    });  
}  
  
/**  
 * æ‰¹é‡åˆ é™¤é¢˜åº“é¢˜ç›®æ€»æ•°  
 *  
 * @param items é¢˜åº“é¢˜ç›®å…³è”åˆ—è¡¨  
 */  
@Override  
public void batchDecrementQuestionCounts(List<QuestionBankQuestion> items) {  
    if (CollUtil.isEmpty(items)) {  
        return;  
    }  
    // èšåˆæ¯ä¸ªé¢˜åº“çš„questionBankIdçš„å¢é‡  
    Map<Long, Integer> counts = items.stream()  
            .collect(Collectors.groupingBy(  
                    QuestionBankQuestion::getQuestionBankId,  
                    Collectors.summingInt(e -> 1)  
                    //ä½œç”¨ç›¸å½“äº COUNT(*) â€”â€” æ¯ä¸ªç›¸åŒ questionBankId çš„å…ƒç´ åŠ  1            ));  
    // é€ä¸ªæ‰§è¡Œé€’å¢  
  
    counts.forEach((bankId, cnt) -> {  
        if (bankId != null && cnt != null && cnt > 0) {  
            boolean ok = questionBankService.update()  
                    .setSql("question_count=question_count-" + cnt)  
                    .eq("id", bankId)  
                    .update();  
            if (!ok) {  
                ThrowUtils.throwIf(ok == false, ErrorCode.OPERATION_ERROR, "æ‰¹é‡æ›´æ–°é¢˜åº“ä¸­é¢˜ç›®æ€»æ•°");  
            }  
        }  
    });  
}
```


es éƒ¨åˆ†åˆ›å»ºåˆ«åç´¢å¼•æ›¿æ¢ï¼Œæ–¹ä¾¿éšæ—¶å›æ»š
```
PUT question_v2
{
  "settings": {
    "number_of_shards": 1,
    "number_of_replicas": 0,
    "analysis": {
      "tokenizer": {
        "my_tokenizer": {
          "type": "ik_max_word",
          "ext_dic_main": [
            "custom.dic"
          ]
        }
      },
      "analyzer": {
        "ik_max_word_analyzer": {
          "type": "custom",
          "tokenizer": "my_tokenizer",
          "filter": ["lowercase"]
        },
        "ik_smart_analyzer": {
          "type": "custom",
          "tokenizer": "ik_smart",
          "filter": ["lowercase"]
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "id": {
        "type": "keyword"
      },
      "title": {
        "type": "text",
        "analyzer": "ik_max_word_analyzer",
        "search_analyzer": "ik_smart_analyzer"
      },
      "content": {
        "type": "text",
        "analyzer": "ik_max_word_analyzer",
        "search_analyzer": "ik_smart_analyzer"
      },
      "tags": {
        "type": "keyword"
      },
      "thumbNum": {
        "type": "long"
      },
      "favourNum": {
        "type": "long"
      },
      "userId": {
        "type": "keyword"
      },
      "createTime": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss"
      },
      "updateTime": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss"
      },
      "isDelete": {
        "type": "keyword"
      }
    }
  }
}



POST /_aliases
{
  "actions": [
    {
      "remove": {
        "index": "question_v1",
        "alias": "question"
      }
    },
    {
      "add": {
        "index": "question_v2",
        "alias": "question"
      }
    }
  ]
}


GET /_cat/aliases/question?v

GET /question/_search
{
  "query": {
    "match": {
      "title": "Java"
    }
  }
}
```



- [ ]  é¢˜åº“è¡¨æ·»åŠ é¢˜ç›®æ€»æ•°å­—æ®µï¼Œå¹¶ä¸”å†ä¿®æ”¹é¢˜ç›®æ‰€å±é¢˜åº“æ—¶å€™è¿›è¡Œï¼ŒåŒæ—¶æ›´æ–°é¢˜åº“è¡¨çš„é¢˜ç›®æ€»æ•°ï¼Œä¸€å®šè¦ç»‘å®šäº‹åŠ¡å›æ»šï¼Œå¯ä»¥åŠ æ•°æ®åº“é”ï¼Œè®¾è®¡å¤šè¡¨æ“ä½œ
- [ ] å¦‚æœä¸€æ¬¡å¤„ç†çš„æ˜¯æ¥è‡ªä¸åŒé¢˜åº“çš„ä¸€æ‰¹é¢˜ï¼ˆå¸¸è§åœºæ™¯ï¼‰ï¼Œå…ˆèšåˆæ¯ä¸ªé¢˜åº“è¦å¢åŠ çš„æ•°é‡ï¼Œç„¶åæ‰¹é‡æ›´æ–°ï¼Œå‡å°‘ DB æ¬¡æ•°ï¼š
- [ ] **é˜²æ­¢é‡å¤ï¼š**Â è§£å†³äº†å®šæ—¶ä»»åŠ¡å› å¤šå®ä¾‹éƒ¨ç½²è€Œé‡å¤æ‰§è¡Œçš„é—®é¢˜- **é«˜å¯ç”¨ï¼š**Â åˆ©ç”¨ Redisson çš„çœ‹é—¨ç‹—å’ŒÂ `tryLock`Â æœºåˆ¶ï¼Œé¿å…äº†æ­»é”çš„é£é™©ã€‚- **å”¯ä¸€æ€§æ‰§è¡Œï¼š**Â åœ¨åˆ†å¸ƒå¼éƒ¨ç½²ç¯å¢ƒä¸‹ï¼ˆä¾‹å¦‚éƒ¨ç½²äº† 3 å°æœåŠ¡å™¨ï¼‰ï¼ŒåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªæœåŠ¡å™¨å®ä¾‹èƒ½å¤ŸæˆåŠŸè·å–é”å¹¶æ‰§è¡Œè¢«æ ‡è®°çš„å®šæ—¶ä»»åŠ¡æ–¹æ³•ã€‚
- [ ] es æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡ï¼Œè‡ªå®šä¹‰è¯å…¸ï¼Œhttps://github.com/PeterMen/elasticsearch-analysis-ik,å®ç°å…ˆæŸ¥ä»esè·å–idï¼Œå†ç”¨idä»æ•°æ®åº“è·å–ç›¸å…³æ•°æ®è¿”å›ï¼Œè®¾ç½®æ£€æŸ¥elasticsearchæ˜¯å¦å¯ç”¨ï¼Œæ²¡æœ‰åˆ™é™çº§ä½¿ç”¨æ•°æ®åº“æŸ¥è¯¢
- [ ] æ›´æ–°å‰ç«¯ï¼Œå®ç°å¹¶å‘è¯·æ±‚ï¼Œåˆ›å»ºå¹¶å‘è¯·æ±‚å·¥å…·ç±»ï¼Œä¸ºæ¯ä¸ªé¡µé¢ç”Ÿæˆmetadataï¼Œé…ç½®sitmap.xml/ts,rotbot.tsï¼Œé…ç½®å…¨å±€å¼‚å¸¸å¤„ç†æ–‡ä»¶global-error.tsx,åŠnot-found.tsx
- [ ] **å®ç°ä¸€ä¸ªè‡ªå®šä¹‰æ³¨è§£å’Œä¸€ä¸ª AOP åˆ‡é¢ï¼Œç”¨äºè‡ªåŠ¨ç¼“å­˜æ–¹æ³•çš„è¿”å›å€¼åˆ°æœ¬åœ°ç¼“å­˜ï¼ˆä¾‹å¦‚ Caffeine æˆ– Guava Cacheï¼‰ä¸­ï¼Œå¹¶ä¸”èƒ½å¤Ÿè‡ªåŠ¨æ¢æµ‹â€œçƒ­ç‚¹ Keyâ€**,å¤šçº§ç¼“å­˜æœºåˆ¶
- [ ] é…ç½®nacosé…ç½®é™çº§æ–¹æ¡ˆæœ¬åœ°æ‹‰å–é…ç½®ï¼Œä»¥åŠä½¿ç”¨dfaè¿‡æ»¤ç®—æ³•
- [ ] nextjs14å‡çº§nextjs16
- [ ] å®ç°åŒç«¯ç™»å½•ä¸‹ï¼Œç¦æ­¢å‰ä¸€ä¸ªå†æ¬¡è®¿é—®ä»»ä½•æ¥å£éƒ½ä¼šå¤±è´¥ï¼Œå­˜å‚¨å†rediså†²çªï¼Œå¯ä»¥å†åœ¨ç”¨æˆ·çœ‹ä¸€æ¬¡åæ ¹æ®æŒ‰é’®å¯ä»¥æ¸…ç†å†²çªæ€ï¼Œå†æ¬¡è®¿é—®ï¼Œä½†æ˜¯éœ€è¦å†æ¬¡ç™»å½•äº†
- [ ] ä½¿ç”¨nextjs çš„swræ¥åšè¯·æ±‚ç¼“å­˜ä¼˜åŒ–
- 1. **è‡ªåŠ¨ç¼“å­˜**ï¼šSWRä¼šè‡ªåŠ¨ç¼“å­˜è¯·æ±‚ç»“æœï¼Œå‡å°‘é‡å¤è¯·æ±‚
2. [ ] **æ•°æ®åŒæ­¥**ï¼šå½“å¤šä¸ªç»„ä»¶ä½¿ç”¨ç›¸åŒæ•°æ®æ—¶ï¼ŒSWRä¼šè‡ªåŠ¨åŒæ­¥æ›´æ–°
3. [ ] **åå°é‡æ–°éªŒè¯**ï¼šSWRä¼šåœ¨åå°å®šæœŸé‡æ–°éªŒè¯æ•°æ®ï¼Œä¿æŒæ•°æ®æ–°é²œ
4. [ ] **é”™è¯¯é‡è¯•**ï¼šå†…ç½®é”™è¯¯é‡è¯•æœºåˆ¶ï¼Œæé«˜åº”ç”¨ç¨³å®šæ€§
5. [ ] **ä¹è§‚æ›´æ–°**ï¼šæ”¯æŒä¹è§‚æ›´æ–°ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
6. [ ] **åˆ†é¡µå’Œæ— é™åŠ è½½**ï¼šå†…ç½®æ”¯æŒåˆ†é¡µå’Œæ— é™åŠ è½½åœºæ™¯



## åœ¨æ‚¨çš„é¡¹ç›®ä¸­ä½¿ç”¨SWRçš„æ­¥éª¤

### 1. åˆ›å»ºSWRé…ç½®æ–‡ä»¶

åœ¨Â `src/libs`Â ç›®å½•ä¸‹åˆ›å»ºÂ `swrConfig.ts`Â æ–‡ä»¶ï¼š

![](resource/images/languageIcon/typescript.svg)

typescript

Apply

```
import useSWR from 'swr';
import myAxios from './request';

// SWR fetcherå‡½æ•°
export const fetcher = async (url: string) => {
  const response = await myAxios.get(url);
  return response.data;
};

// å¸¦å‚æ•°çš„fetcher
export const fetcherWithParams = async ([url, params]: [string, any]) => {
  const response = await myAxios.get(url, { params });
  return response.data;
};

// POSTè¯·æ±‚çš„fetcher
export const poster = async ([url, data]: [string, any]) => {
  const response = await myAxios.post(url, data);
  return response.data;
};

// è‡ªå®šä¹‰SWR Hook
export const useApi = (url: string, config?: any) => {
  const { data, error, mutate, isLoading } = useSWR(url, fetcher, {
    revalidateOnFocus: false, // çª—å£èšç„¦æ—¶ä¸è‡ªåŠ¨é‡æ–°éªŒè¯
    revalidateOnReconnect: true, // ç½‘ç»œé‡è¿æ—¶é‡æ–°éªŒè¯
    errorRetryCount: 3, // é”™è¯¯é‡è¯•æ¬¡æ•°
    errorRetryInterval: 5000, // é”™è¯¯é‡è¯•é—´éš”
    ...config
  });

  return {
    data,
    error,
    mutate,
    isLoading,
    isError: !!error,
    isSuccess: !!data && !error
  };
};

// å¸¦å‚æ•°çš„API Hook
export const useApiWithParams = (url: string, params: any, config?: any) => {
  const { data, error, mutate, isLoading } = useSWR(
    params ? [url, params] : null,
    fetcherWithParams,
    {
      revalidateOnFocus: false,
      revalidateOnReconnect: true,
      errorRetryCount: 3,
      errorRetryInterval: 5000,
      ...config
    }
  );

  return {
    data,
    error,
    mutate,
    isLoading,
    isError: !!error,
    isSuccess: !!data && !error
  };
};
```

### 2. åˆ›å»ºAPIæœåŠ¡å±‚

åœ¨Â `src/services`Â ç›®å½•ä¸‹åˆ›å»ºÂ `userService.ts`Â æ–‡ä»¶ï¼š

![](resource/images/languageIcon/typescript.svg)

typescript

Apply

```
import { useApi, useApiWithParams } from '@/libs/swrConfig';

// ç”¨æˆ·ç›¸å…³API
export const useCurrentUser = () => {
  return useApi('/api/user/get/login');
};

export const useUserSignInRecord = (year: number) => {
  return useApiWithParams('/api/user/get/sign_in', { year });
};

// é¢˜åº“ç›¸å…³API
export const useQuestionBankList = (params: any) => {
  return useApiWithParams('/api/bank/list/page', params);
};

export const useQuestionBankDetail = (id: string) => {
  return useApiWithParams('/api/bank/get', { id });
};
```

### 3. ä¿®æ”¹CalendarChartç»„ä»¶ä½¿ç”¨SWR

ä¿®æ”¹Â `src/app/user/center/components/CalendarChart/index.tsx`ï¼š

![](resource/images/languageIcon/typescript.svg)

typescript

Apply

```
import ReactECharts from "echarts-for-react";
import { useEffect, useState } from "react";
import dayjs from "dayjs";
import { useUserSignInRecord } from "@/services/userService";

interface Props {}
/**
 * åˆ·é¢˜æ—¥å†å›¾
 * @param props
 * @constructor
 */
const CalendarChart = (props: Props) => {
  //ç­¾åˆ°æ—¥æœŸåˆ—è¡¨ï¼ˆ[1,200]ï¼‰ ,è¡¨ç¤ºç¬¬ä¸€å¤©å’Œç¬¬200å¤©ç­¾åˆ°è®°å½•
  const [dataList, setDataList] = useState<number[]>([]);
  //è®¡ç®—å›¾æ ‡æ‰€éœ€è¦çš„æ•°æ®
  const year = new Date().getFullYear();
  
  // ä½¿ç”¨SWRè·å–æ•°æ®
  const { data: signInData, isLoading, error } = useUserSignInRecord(year);
  
  // å½“æ•°æ®å˜åŒ–æ—¶æ›´æ–°æœ¬åœ°çŠ¶æ€
  useEffect(() => {
    if (signInData) {
      setDataList(signInData as any);
    }
  }, [signInData]);

  // å¤„ç†é”™è¯¯
  useEffect(() => {
    if (error) {
      console.error("è·å–åˆ·é¢˜è®°å½•å¤±è´¥ï¼Œ", error);
    }
  }, [error]);

  const optionsData = dataList.map((dayOfYear) => {
    //è®¡ç®—æ—¥æœŸå­—ç¬¦ä¸²
    const dateStr = dayjs(`${year}-01-01`)
      .add(dayOfYear - 1, "day")
      .format("YYYY-MM-DD");
    return [dateStr, 1];
  });

  const option = {
    visualMap: {
      show: false,
      min: 0,
      max: 1,
      inRange: {
        color: ["#efefef", "lightgreen"], //é¢œè‰²ä»ç°è‰²åˆ°æµ…ç»¿
      },
    },
    calendar: {
      cellSize: ["auto", 16],
      range: year,
      yearLabel: {
        position: "top",
        formatter: `${year}å¹´åˆ·é¢˜è®°å½•`,
      },
      left: 20,
    },
    series: {
      type: "heatmap",
      coordinateSystem: "calendar",
      data: optionsData,
    },
  };
  
  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  if (isLoading) {
    return <div>åŠ è½½ä¸­...</div>;
  }
  
  return (
    <div className="Calendar-chart">
      <ReactECharts option={option} style={{ height: 400 }} />
    </div>
  );
};

export default CalendarChart;
```

### 4. ä¿®æ”¹InitLayoutä½¿ç”¨SWR

ä¿®æ”¹Â `src/app/layout.tsx`Â ä¸­çš„InitLayoutç»„ä»¶ï¼š

![](resource/images/languageIcon/typescript.svg)

typescript

Apply

```
// å¯¼å…¥SWRç›¸å…³
import { useCurrentUser } from "@/services/userService";

// ä¿®æ”¹InitLayoutç»„ä»¶
const InitLayout: React.FC<
Readonly<{
  children: React.ReactNode;
}>
> = ({ children }) => {
  const pathname = usePathname();
  const dispatch = useDispatch<AppDispatch>();
  
  // ä½¿ç”¨SWRè·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
  const { data: userData, isLoading, error } = useCurrentUser();
  
  useEffect(() => {
    if (
      !pathname.startsWith("/user/login") &&
      !pathname.startsWith("/user/register") &&
      userData
    ) {
      // æ›´æ–°å…¨å±€çŠ¶æ€
      dispatch(setLoginUser(userData));
    }
  }, [userData, dispatch, pathname]);

  // å¤„ç†é”™è¯¯
  useEffect(() => {
    if (error) {
      console.log('è·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯å¤±è´¥', error);
    }
  }, [error]);

  return <>{children}</>;
};
```

### 5. åˆ›å»ºSWR Provider

åœ¨Â `src/app/providers`Â ç›®å½•ä¸‹åˆ›å»ºÂ `swr-provider.tsx`ï¼š

![](resource/images/languageIcon/typescript.svg)

typescript

Apply

```
'use client';

import { SWRConfig } from 'swr';

export const SWRProvider = ({ children }: { children: React.ReactNode }) => {
  return (
    <SWRConfig
      value={{
        revalidateOnFocus: false,
        revalidateOnReconnect: true,
        errorRetryCount: 3,
        errorRetryInterval: 5000,
      }}
    >
      {children}
    </SWRConfig>
  );
};
```

### 6. ä¿®æ”¹æ ¹å¸ƒå±€æ·»åŠ SWR Provider

ä¿®æ”¹Â `src/app/layout.tsx`Â æ·»åŠ SWR Providerï¼š

![](resource/images/languageIcon/typescript.svg)

typescript

Apply

```
import { SWRProvider } from "./providers/swr-provider";

const RootLayout: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  return (
    <html lang="zh">
      <body>
        <AntdRegistry>
          <SWRProvider>
            <Provider store={stores}>
              <InitLayout>
                <BasicLayout>
                  <AccessLayout>
                    {children}
                    <LoginConflictAlert/>
                  </AccessLayout>
                </BasicLayout>
              </InitLayout>
            </Provider>
          </SWRProvider>
        </AntdRegistry>
      </body>
    </html>
  );
};
```

### 7. ä¿®æ”¹è¯·æ±‚æ‹¦æˆªå™¨å¤„ç†40110é”™è¯¯

ä¿®æ”¹Â `src/libs/request.ts`Â ä¸­çš„å“åº”æ‹¦æˆªå™¨ï¼š

![](resource/images/languageIcon/typescript.svg)

typescript

Apply

```
// åœ¨å“åº”æ‹¦æˆªå™¨ä¸­æ·»åŠ 40110å¤„ç†
myAxios.interceptors.response.use(
  function (response) {
    const { data } = response;
    
    // å¤„ç†ç™»å½•å†²çª
    if (data.code === 40110) {
      if (typeof window !== 'undefined') {
        loginConflictState.showConflictAlert();
      }
      return Promise.reject(new Error('ç™»å½•å†²çª'));
    }
    
    // å…¶ä»–ç°æœ‰é€»è¾‘...
    
    return data;
  },
  function (error) {
    return Promise.reject(error);
  }
);
```

## ä½¿ç”¨SWRçš„ä¼˜åŠ¿

1. **è‡ªåŠ¨ç¼“å­˜**ï¼šSWRä¼šè‡ªåŠ¨ç¼“å­˜è¯·æ±‚ç»“æœï¼Œå‡å°‘é‡å¤è¯·æ±‚
2. **æ•°æ®åŒæ­¥**ï¼šå½“å¤šä¸ªç»„ä»¶ä½¿ç”¨ç›¸åŒæ•°æ®æ—¶ï¼ŒSWRä¼šè‡ªåŠ¨åŒæ­¥æ›´æ–°
3. **åå°é‡æ–°éªŒè¯**ï¼šSWRä¼šåœ¨åå°å®šæœŸé‡æ–°éªŒè¯æ•°æ®ï¼Œä¿æŒæ•°æ®æ–°é²œ
4. **é”™è¯¯é‡è¯•**ï¼šå†…ç½®é”™è¯¯é‡è¯•æœºåˆ¶ï¼Œæé«˜åº”ç”¨ç¨³å®šæ€§
5. **ä¹è§‚æ›´æ–°**ï¼šæ”¯æŒä¹è§‚æ›´æ–°ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

## è¿ç§»å»ºè®®

1. **é€æ­¥è¿ç§»**ï¼šä¸éœ€è¦ä¸€æ¬¡æ€§å°†æ‰€æœ‰APIè°ƒç”¨éƒ½æ”¹ä¸ºSWRï¼Œå¯ä»¥å…ˆä»é¢‘ç¹ä½¿ç”¨çš„APIå¼€å§‹
2. **ä¿æŒå…¼å®¹**ï¼šSWRå¯ä»¥ä¸ç°æœ‰çš„ReduxçŠ¶æ€ç®¡ç†å…±å­˜ï¼Œå¯ä»¥é€æ­¥è¿ç§»
3. **é‡ç‚¹ä¼˜åŒ–**ï¼šä¼˜å…ˆä¼˜åŒ–é¢‘ç¹è®¿é—®ã€å˜åŒ–ä¸é¢‘ç¹çš„æ•°æ®ï¼Œå¦‚ç”¨æˆ·ä¿¡æ¯ã€é…ç½®æ•°æ®ç­‰

## å®é™…ä½¿ç”¨ç¤ºä¾‹

åœ¨ç»„ä»¶ä¸­ä½¿ç”¨SWRéå¸¸ç®€å•ï¼š

![](resource/images/languageIcon/typescript.svg)

typescript

Apply

```
// åœ¨ä»»ä½•ç»„ä»¶ä¸­ä½¿ç”¨
import { useCurrentUser } from "@/services/userService";

const UserProfile = () => {
  const { data: user, isLoading, error } = useCurrentUser();
  
  if (isLoading) return <div>åŠ è½½ä¸­...</div>;
  if (error) return <div>åŠ è½½å¤±è´¥</div>;
  
  return <div>æ¬¢è¿ï¼Œ{user?.userName}</div>;
};
```

é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œæ‚¨å¯ä»¥åœ¨å½“å‰é¡¹ç›®ä¸­æˆåŠŸæ¥å…¥SWRï¼Œå®ç°æ•°æ®ç¼“å­˜ä¼˜åŒ–ï¼Œæå‡åº”ç”¨æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚ç”±äºæ‚¨å·²ç»å®‰è£…äº†SWRï¼Œåªéœ€è¦æŒ‰ç…§ä¸Šè¿°æ­¥éª¤åˆ›å»ºé…ç½®æ–‡ä»¶å’ŒæœåŠ¡å±‚ï¼Œç„¶åé€æ­¥æ›¿æ¢ç°æœ‰çš„APIè°ƒç”¨å³å¯ã€‚